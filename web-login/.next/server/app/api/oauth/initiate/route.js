"use strict";(()=>{var e={};e.id=734,e.ids=[734],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},5805:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>O,patchFetch:()=>v,requestAsyncStorage:()=>g,routeModule:()=>p,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{GET:()=>_,POST:()=>d});var i=r(3277),n=r(5265),a=r(5356),o=r(7076),u=r(2851),l=r(4770),c=r.n(l),h=r(6190);async function _(e){try{let t=e.nextUrl.searchParams,r=t.get("amazon_account_id")||null,s=t.get("email"),i=t.get("license_key");if(!s||!i)return o.NextResponse.redirect(new URL("/?error=Email and license key are required",e.url));let n="https://mwvurelnhrcbtpjtsiyb.supabase.co",a=process.env.SUPABASE_SERVICE_KEY||"";if(!n||!a)return o.NextResponse.redirect(new URL("/?error=Server configuration error",e.url));let l=(0,u.createClient)(n,a),{data:_,error:d}=await l.from("licenses").select("status").eq("license_key",i).single();if(d||!_||"active"!==_.status)return o.NextResponse.redirect(new URL("/?error=Invalid or inactive license key",e.url));let p=c().randomBytes(32).toString("hex"),g=c().randomBytes(32).toString("base64url");await (0,h.N1)(p,s,i,r,g);let m=process.env.NOTION_CLIENT_ID||"",x=process.env.NOTION_REDIRECT_URI||"";if(!m||!x)return o.NextResponse.redirect(new URL("/?error=Missing Notion OAuth configuration",e.url));let O=new URL("https://api.notion.com/v1/oauth/authorize");return O.searchParams.set("client_id",m),O.searchParams.set("redirect_uri",x),O.searchParams.set("response_type","code"),O.searchParams.set("owner","user"),O.searchParams.set("state",p),o.NextResponse.redirect(O.toString())}catch(t){return console.error("OAuth initiation error:",t),o.NextResponse.redirect(new URL("/?error=OAuth initiation failed",e.url))}}async function d(e){try{let t="https://mwvurelnhrcbtpjtsiyb.supabase.co",r=process.env.SUPABASE_SERVICE_KEY||"",s=process.env.NOTION_CLIENT_ID||"",i=process.env.NOTION_REDIRECT_URI||"";if(!t||!r)return o.NextResponse.json({error:"Missing Supabase environment variables"},{status:500});if(!s||!i)return o.NextResponse.json({error:"Missing Notion OAuth configuration"},{status:500});(0,u.createClient)(t,r);let{email:n,licenseKey:a,amazon_account_id:l,auth_user_id:_}=await e.json();if(!n)return o.NextResponse.json({error:"Email is required"},{status:400});let d=c().randomBytes(32).toString("base64url"),p=c().randomBytes(32).toString("hex");console.log("[OAuth Initiate] Creating OAuth session:",{state:p.substring(0,16)+"...",email:n,has_license_key:!!a,has_amazon_account_id:!!l,auth_user_id:_||null});try{let e=await (0,h.N1)(p,n,a||"",l||null,d,_||null);console.log("[OAuth Initiate] ✅ OAuth session created:",{session_id:e.id,state:e.state.substring(0,16)+"...",auth_user_id:e.auth_user_id,expires_at:e.expires_at})}catch(e){return console.error("[OAuth Initiate] ❌ Failed to create OAuth session:",e),o.NextResponse.json({error:`Failed to create OAuth session: ${e.message}`},{status:500})}let g=new URL("https://api.notion.com/v1/oauth/authorize");return g.searchParams.set("client_id",s),g.searchParams.set("redirect_uri",i),g.searchParams.set("response_type","code"),g.searchParams.set("owner","user"),g.searchParams.set("state",p),o.NextResponse.json({authUrl:g.toString(),state:p})}catch(e){return console.error("OAuth initiation error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/oauth/initiate/route",pathname:"/api/oauth/initiate",filename:"route",bundlePath:"app/api/oauth/initiate/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\initiate\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:x}=p,O="/api/oauth/initiate/route";function v(){return(0,a.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:m})}},6190:(e,t,r)=>{r.d(t,{Az:()=>o,N1:()=>a,W3:()=>u});var s=r(2851);let i="https://mwvurelnhrcbtpjtsiyb.supabase.co",n=process.env.SUPABASE_SERVICE_KEY||"";async function a(e,t,r,a,o,u){let l=(0,s.createClient)(i,n),c=new Date(Date.now()+6e5).toISOString();console.log("[OAuth Session] Attempting to insert session:",{state:e.substring(0,16)+"...",email:t,has_license_key:!!r,has_amazon_account_id:!!a,has_auth_user_id:!!u,auth_user_id:u,expires_at:c});let{data:h,error:_}=await l.from("oauth_sessions").insert({state:e,email:t,license_key:r||null,amazon_account_id:a,auth_user_id:u||null,code_verifier:o,expires_at:c}).select().single();if(_)throw console.error("[OAuth Session] ❌ Insert error:",{error_code:_.code,error_message:_.message,error_details:_.details,error_hint:_.hint}),Error(`Failed to create OAuth session: ${_.message} (code: ${_.code})`);return console.log("[OAuth Session] ✅ Session created successfully:",{session_id:h?.id,state:h?.state?.substring(0,16)+"...",auth_user_id:h?.auth_user_id}),h}async function o(e){let t=(0,s.createClient)(i,n);console.log("[OAuth Session] Retrieving session for state:",e.substring(0,16)+"...");let{data:r,error:a}=await t.from("oauth_sessions").select("*").eq("state",e).gt("expires_at",new Date().toISOString()).single();return a?(console.error("[OAuth Session] ❌ Retrieval error:",{error_code:a.code,error_message:a.message,error_details:a.details,error_hint:a.hint,state:e.substring(0,16)+"..."}),null):r?(console.log("[OAuth Session] ✅ Session retrieved:",{session_id:r.id,email:r.email,has_auth_user_id:!!r.auth_user_id,auth_user_id:r.auth_user_id,expires_at:r.expires_at}),r):(console.warn("[OAuth Session] ⚠️ No session found for state:",e.substring(0,16)+"..."),null)}async function u(e){let t=(0,s.createClient)(i,n),{error:r}=await t.from("oauth_sessions").delete().eq("state",e);r&&console.error("Failed to delete OAuth session:",r)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[942,786,851],()=>r(5805));module.exports=s})();