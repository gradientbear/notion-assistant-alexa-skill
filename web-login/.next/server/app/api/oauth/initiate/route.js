"use strict";(()=>{var e={};e.id=734,e.ids=[734],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},5805:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>x,requestAsyncStorage:()=>_,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{GET:()=>h,POST:()=>d});var n=r(3277),a=r(5265),o=r(5356),i=r(7076),u=r(2851),l=r(4770),c=r.n(l),p=r(6190);async function h(e){try{let t=e.nextUrl.searchParams,r=t.get("amazon_account_id")||null,s=t.get("email"),n=t.get("license_key");if(!s||!n)return i.NextResponse.redirect(new URL("/?error=Email and license key are required",e.url));let a="https://ptasyynqqlvrbhqmtvhl.supabase.co",o=process.env.SUPABASE_SERVICE_KEY||"";if(!a||!o)return i.NextResponse.redirect(new URL("/?error=Server configuration error",e.url));let l=(0,u.eI)(a,o),{data:h,error:d}=await l.from("licenses").select("status").eq("license_key",n).single();if(d||!h||"active"!==h.status)return i.NextResponse.redirect(new URL("/?error=Invalid or inactive license key",e.url));let m=c().randomBytes(32).toString("hex"),_=c().randomBytes(32).toString("base64url");await (0,p.N1)(m,s,n,r,_);let v=process.env.NOTION_CLIENT_ID||"",g=process.env.NOTION_REDIRECT_URI||"";if(!v||!g)return i.NextResponse.redirect(new URL("/?error=Missing Notion OAuth configuration",e.url));let R=new URL("https://api.notion.com/v1/oauth/authorize");return R.searchParams.set("client_id",v),R.searchParams.set("redirect_uri",g),R.searchParams.set("response_type","code"),R.searchParams.set("owner","user"),R.searchParams.set("state",m),i.NextResponse.redirect(R.toString())}catch(t){return console.error("OAuth initiation error:",t),i.NextResponse.redirect(new URL("/?error=OAuth initiation failed",e.url))}}async function d(e){try{let t="https://ptasyynqqlvrbhqmtvhl.supabase.co",r=process.env.SUPABASE_SERVICE_KEY||"",s=process.env.NOTION_CLIENT_ID||"",n=process.env.NOTION_REDIRECT_URI||"";if(!t||!r)return i.NextResponse.json({error:"Missing Supabase environment variables"},{status:500});if(!s||!n)return i.NextResponse.json({error:"Missing Notion OAuth configuration"},{status:500});(0,u.eI)(t,r);let{email:a,licenseKey:o,amazon_account_id:l,auth_user_id:h}=await e.json();if(!a)return i.NextResponse.json({error:"Email is required"},{status:400});let d=c().randomBytes(32).toString("base64url"),m=c().randomBytes(32).toString("hex");await (0,p.N1)(m,a,o||"",l||null,d,h||null);let _=new URL("https://api.notion.com/v1/oauth/authorize");return _.searchParams.set("client_id",s),_.searchParams.set("redirect_uri",n),_.searchParams.set("response_type","code"),_.searchParams.set("owner","user"),_.searchParams.set("state",m),i.NextResponse.json({authUrl:_.toString(),state:m})}catch(e){return console.error("OAuth initiation error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/oauth/initiate/route",pathname:"/api/oauth/initiate",filename:"route",bundlePath:"app/api/oauth/initiate/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\initiate\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:v,serverHooks:g}=m,R="/api/oauth/initiate/route";function x(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:v})}},6190:(e,t,r)=>{r.d(t,{Az:()=>i,N1:()=>o,W3:()=>u});var s=r(2851);let n="https://ptasyynqqlvrbhqmtvhl.supabase.co",a=process.env.SUPABASE_SERVICE_KEY||"";async function o(e,t,r,o,i,u){let l=(0,s.eI)(n,a),c=new Date(Date.now()+6e5).toISOString(),{data:p,error:h}=await l.from("oauth_sessions").insert({state:e,email:t,license_key:r||null,amazon_account_id:o,auth_user_id:u||null,code_verifier:i,expires_at:c}).select().single();if(h)throw Error(`Failed to create OAuth session: ${h.message}`);return p}async function i(e){let t=(0,s.eI)(n,a),{data:r,error:o}=await t.from("oauth_sessions").select("*").eq("state",e).gt("expires_at",new Date().toISOString()).single();return o||!r?null:r}async function u(e){let t=(0,s.eI)(n,a),{error:r}=await t.from("oauth_sessions").delete().eq("state",e);r&&console.error("Failed to delete OAuth session:",r)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[942,786,851],()=>r(5805));module.exports=s})();