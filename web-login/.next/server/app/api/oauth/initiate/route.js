"use strict";(()=>{var e={};e.id=734,e.ids=[734],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1224:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>f,requestAsyncStorage:()=>v,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{GET:()=>h,POST:()=>d});var a=r(3277),n=r(5265),i=r(5356),o=r(7076),u=r(2851);let l=require("crypto");var c=r.n(l),p=r(6190);async function h(e){try{let t=e.nextUrl.searchParams,r=t.get("amazon_account_id")||null,s=t.get("email"),a=t.get("license_key");if(!s||!a)return o.NextResponse.redirect(new URL("/?error=Email and license key are required",e.url));let n="https://ptasyynqqlvrbhqmtvhl.supabase.co",i=process.env.SUPABASE_SERVICE_KEY||"";if(!n||!i)return o.NextResponse.redirect(new URL("/?error=Server configuration error",e.url));let l=(0,u.eI)(n,i),{data:h,error:d}=await l.from("licenses").select("status").eq("license_key",a).single();if(d||!h||"active"!==h.status)return o.NextResponse.redirect(new URL("/?error=Invalid or inactive license key",e.url));let m=c().randomBytes(32).toString("hex"),v=c().randomBytes(32).toString("base64url");await (0,p.N1)(m,s,a,r,v);let _=process.env.NOTION_CLIENT_ID||"",g=process.env.NOTION_REDIRECT_URI||"";if(!_||!g)return o.NextResponse.redirect(new URL("/?error=Missing Notion OAuth configuration",e.url));let R=new URL("https://api.notion.com/v1/oauth/authorize");return R.searchParams.set("client_id",_),R.searchParams.set("redirect_uri",g),R.searchParams.set("response_type","code"),R.searchParams.set("owner","user"),R.searchParams.set("state",m),o.NextResponse.redirect(R.toString())}catch(t){return console.error("OAuth initiation error:",t),o.NextResponse.redirect(new URL("/?error=OAuth initiation failed",e.url))}}async function d(e){try{let t="https://ptasyynqqlvrbhqmtvhl.supabase.co",r=process.env.SUPABASE_SERVICE_KEY||"",s=process.env.NOTION_CLIENT_ID||"",a=process.env.NOTION_REDIRECT_URI||"";if(!t||!r)return o.NextResponse.json({error:"Missing Supabase environment variables"},{status:500});if(!s||!a)return o.NextResponse.json({error:"Missing Notion OAuth configuration"},{status:500});let n=(0,u.eI)(t,r),{email:i,licenseKey:l,amazon_account_id:h,auth_user_id:d}=await e.json();if(!i)return o.NextResponse.json({error:"Email is required"},{status:400});if(l){let{data:e,error:t}=await n.from("licenses").select("status").eq("license_key",l).single();if(t||!e||"active"!==e.status)return o.NextResponse.json({error:"Invalid or inactive license key"},{status:401})}let m=c().randomBytes(32).toString("base64url"),v=c().randomBytes(32).toString("hex");await (0,p.N1)(v,i,l||"",h||null,m,d||null);let _=new URL("https://api.notion.com/v1/oauth/authorize");return _.searchParams.set("client_id",s),_.searchParams.set("redirect_uri",a),_.searchParams.set("response_type","code"),_.searchParams.set("owner","user"),_.searchParams.set("state",v),o.NextResponse.json({authUrl:_.toString(),state:v})}catch(e){return console.error("OAuth initiation error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/oauth/initiate/route",pathname:"/api/oauth/initiate",filename:"route",bundlePath:"app/api/oauth/initiate/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\initiate\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:_,serverHooks:g}=m,R="/api/oauth/initiate/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},6190:(e,t,r)=>{r.d(t,{Az:()=>o,N1:()=>i,W3:()=>u});var s=r(2851);let a="https://ptasyynqqlvrbhqmtvhl.supabase.co",n=process.env.SUPABASE_SERVICE_KEY||"";async function i(e,t,r,i,o,u){let l=(0,s.eI)(a,n),c=new Date(Date.now()+6e5).toISOString(),{data:p,error:h}=await l.from("oauth_sessions").insert({state:e,email:t,license_key:r||null,amazon_account_id:i,auth_user_id:u||null,code_verifier:o,expires_at:c}).select().single();if(h)throw Error(`Failed to create OAuth session: ${h.message}`);return p}async function o(e){let t=(0,s.eI)(a,n),{data:r,error:i}=await t.from("oauth_sessions").select("*").eq("state",e).gt("expires_at",new Date().toISOString()).single();return i||!r?null:r}async function u(e){let t=(0,s.eI)(a,n),{error:r}=await t.from("oauth_sessions").delete().eq("state",e);r&&console.error("Failed to delete OAuth session:",r)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[942,786,851],()=>r(1224));module.exports=s})();