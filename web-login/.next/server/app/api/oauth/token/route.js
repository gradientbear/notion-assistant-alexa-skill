"use strict";(()=>{var e={};e.id=867,e.ids=[867],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1983:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var o={};t.r(o),t.d(o,{POST:()=>l,dynamic:()=>u});var s=t(3277),n=t(5265),i=t(5356),a=t(7076),c=t(8675),d=t(1570);let u="force-dynamic";async function l(e){try{let r,t,o;console.log("[OAuth Token] Full request:",{url:e.url,method:e.method,contentType:e.headers.get("content-type"),headers:Object.fromEntries(e.headers.entries())}),console.log("[OAuth Token] ✅ Reached body parsing section");let s=e.headers.get("content-type");console.log("[OAuth Token] Attempting to parse body, content-type:",s);try{if(s?.includes("application/x-www-form-urlencoded")){console.log("[OAuth Token] Parsing as form-urlencoded...");try{let t=await e.formData();r=Object.fromEntries(t.entries()),console.log("[OAuth Token] Parsed form data via formData():",Object.keys(r))}catch(o){console.warn("[OAuth Token] formData() failed, trying text() method:",{error:o.message,error_name:o.name});let t=await e.text();for(let[e,o]of(console.log("[OAuth Token] Raw body text length:",t.length),r={},new URLSearchParams(t).entries()))r[e]=o;console.log("[OAuth Token] Parsed form data via text():",Object.keys(r))}console.log("[OAuth Token] Form data values:",{grant_type:r.grant_type,has_code:!!r.code,has_redirect_uri:!!r.redirect_uri,has_client_id:!!r.client_id,has_client_secret:!!r.client_secret,code_preview:r.code?r.code.substring(0,10)+"...":"missing"})}else console.log("[OAuth Token] Parsing as JSON..."),r=await e.json(),console.log("[OAuth Token] Parsed JSON body:",Object.keys(r))}catch(e){return console.error("[OAuth Token] Error parsing request body:",{error:e.message,error_name:e.name,contentType:s,error_stack:e.stack}),a.NextResponse.json({error:"invalid_request",error_description:"Failed to parse request body"},{status:400})}if(!r||0===Object.keys(r).length)return console.error("[OAuth Token] Body is empty or invalid:",{body:r}),a.NextResponse.json({error:"invalid_request",error_description:"Empty request body"},{status:400});let n=r.grant_type,i=e.headers.get("authorization");if(i?.startsWith("Basic ")){console.log("[OAuth Token] Found Basic Auth header, extracting credentials...");try{let e=i.substring(6),[r,s]=Buffer.from(e,"base64").toString("utf-8").split(":");t=r?.trim(),o=s?.trim(),console.log("[OAuth Token] Extracted from Basic Auth:",{client_id_preview:t?`${t.substring(0,8)}...`:"missing",has_client_secret:!!o})}catch(e){console.error("[OAuth Token] Error parsing Basic Auth:",{error:e.message})}}t||(t=r.client_id?.trim()),o||(o=r.client_secret?.trim()),console.log("[OAuth Token] Request body parsed:",{grant_type:n,has_code:!!r.code,has_redirect_uri:!!r.redirect_uri,has_client_id:!!t,has_client_secret:!!o,client_id_source:i?.startsWith("Basic ")?"Basic Auth header":"request body",code_preview:r.code?r.code.substring(0,10)+"...":"missing"});let u=process.env.ALEXA_OAUTH_CLIENT_ID?.trim(),l=process.env.ALEXA_OAUTH_CLIENT_SECRET?.trim();if(console.log("[OAuth Token] Client validation:",{clientIdReceived:t?`${t.substring(0,8)}...`:"missing",clientIdExpected:u?`${u.substring(0,8)}...`:"missing",clientSecretReceived:o?"***":"missing",clientSecretExpected:l?"***":"missing",clientIdMatch:t===u,hasClientIdEnv:!!u,hasClientSecretEnv:!!l}),!t)return a.NextResponse.json({error:"invalid_client",error_description:"Missing client_id parameter"},{status:401});if(!u)return console.error("[OAuth Token] ALEXA_OAUTH_CLIENT_ID environment variable is not set"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});if(t!==u)return console.error("[OAuth Token] Client ID mismatch"),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_id"},{status:401});if(!o)return a.NextResponse.json({error:"invalid_client",error_description:"Missing client_secret parameter"},{status:401});if(!l)return console.error("[OAuth Token] ALEXA_OAUTH_CLIENT_SECRET environment variable is not set"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});if(o!==l)return console.error("[OAuth Token] Client secret mismatch"),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_secret"},{status:401});if("authorization_code"===n){let e,o;let s=r.code,n=r.redirect_uri,i=r.code_verifier;if(!s||!n)return a.NextResponse.json({error:"invalid_request",error_description:"Missing code or redirect_uri"},{status:400});console.log("[OAuth Token] Validating authorization code:",{code_preview:s?s.substring(0,10)+"...":"missing",client_id:t?t.substring(0,8)+"...":"missing",redirect_uri:n,has_code_verifier:!!i});try{e=await (0,c.gJ)(s,t,n,i)}catch(e){return console.error("[OAuth Token] Authorization code validation error:",{error:e,error_message:e?.message,error_stack:e?.stack}),a.NextResponse.json({error:"invalid_grant",error_description:"Invalid or expired authorization code"},{status:400})}if(!e)return console.error("[OAuth Token] Authorization code validation failed - no result returned"),a.NextResponse.json({error:"invalid_grant",error_description:"Invalid or expired authorization code"},{status:400});console.log("[OAuth Token] Authorization code validated successfully:",{user_id:e.userId,scope:e.scope});let u=(0,d.createServerClient)(),{data:l,error:_}=await u.from("users").select("*").eq("id",e.userId).single();if(_||!l)return console.error("[OAuth Token] User lookup failed:",{user_id:e.userId,error:_,error_code:_?.code,error_message:_?.message}),a.NextResponse.json({error:"server_error",error_description:"User not found"},{status:500});try{o=await (0,c.yh)(l.id,t,e.scope,l.tasks_db_id||void 0,l.amazon_account_id||void 0)}catch(e){return console.error("[OAuth Token] Token issuance error:",{error:e,error_message:e?.message,error_stack:e?.stack,user_id:l.id}),a.NextResponse.json({error:"server_error",error_description:"Failed to issue access token"},{status:500})}return console.log("[OAuth Token] Issued token for user:",{user_id:l.id,email:l.email,has_amazon_account_id:!!l.amazon_account_id,token_preview:o.access_token.substring(0,20)+"...",expires_in:o.expires_in}),a.NextResponse.json({access_token:o.access_token,token_type:"Bearer",expires_in:o.expires_in,refresh_token:o.refresh_token,scope:e.scope})}if("refresh_token"!==n)return a.NextResponse.json({error:"unsupported_grant_type",error_description:`Grant type "${n}" is not supported`},{status:400});if(!r.refresh_token)return a.NextResponse.json({error:"invalid_request",error_description:"Missing refresh_token"},{status:400});return a.NextResponse.json({error:"unsupported_grant_type",error_description:"Refresh token grant not yet implemented"},{status:400})}catch(e){return console.error("[OAuth Token] Unexpected error:",{error:e,error_message:e?.message,error_stack:e?.stack,error_name:e?.name}),a.NextResponse.json({error:"server_error",error_description:e?.message||"Internal server error"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/oauth/token/route",pathname:"/api/oauth/token",filename:"route",bundlePath:"app/api/oauth/token/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\token\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:g}=_,m="/api/oauth/token/route";function k(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},8675:(e,r,t)=>{t.d(r,{$B:()=>_,Gc:()=>c,PX:()=>l,S5:()=>p,Sv:()=>a,gJ:()=>d,rG:()=>h,yh:()=>u});var o=t(4770),s=t.n(o),n=t(1570);let i="true"===process.env.REFRESH_TOKEN_ENABLED;function a(){return s().randomBytes(32).toString("base64url")}async function c(e,r,t,o,s="alexa",i,a){let c=(0,n.createServerClient)(),d=new Date(Date.now()+6e5),{data:u,error:l}=await c.from("users").select("id").eq("id",r).single();if(l||!u)throw console.error("[OAuth] User does not exist when storing auth code:",{user_id:r,error:l,user_found:!!u}),Error(`User ${r} does not exist in database`);let{error:_}=await c.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:s,code_challenge:i,code_challenge_method:a,expires_at:d.toISOString()});if(_)throw console.error("[OAuth] Error storing auth code:",{error_code:_.code,error_message:_.message,error_details:_.details,error_hint:_.hint,user_id:r,user_exists:!!u}),Error(`Failed to store authorization code: ${_.message}`)}async function d(e,r,t,o){let i=(0,n.createServerClient)();try{let{data:n,error:a}=await i.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();if(a||!n)return console.warn("[OAuth] Invalid authorization code:",{code_preview:e?e.substring(0,10)+"...":"missing",client_id:r,redirect_uri:t,error:a,error_code:a?.code,error_message:a?.message}),null;if(new Date(n.expires_at)<new Date)return console.warn("[OAuth] Authorization code expired:",{expires_at:n.expires_at,now:new Date().toISOString()}),null;if(n.used)return console.warn("[OAuth] Authorization code already used:",{code_preview:e.substring(0,10)+"...",used_at:n.used_at}),null;if(n.code_challenge&&o&&s().createHash("sha256").update(o).digest("base64url")!==n.code_challenge)return console.warn("[OAuth] PKCE code verifier mismatch"),null;let{error:c}=await i.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e);return c&&console.error("[OAuth] Failed to mark authorization code as used:",{error:c,error_code:c.code,error_message:c.message}),{userId:n.user_id,scope:n.scope}}catch(e){return console.error("[OAuth] Error validating authorization code:",{error:e,error_message:e?.message,error_stack:e?.stack}),null}}async function u(e,r,t,o,a){let c;let d=(0,n.createServerClient)(),{data:u,error:l}=await d.from("users").select("email").eq("id",e).single();if(l||!u)throw Error("User not found");let _=s().randomBytes(32).toString("base64url"),h=parseInt(process.env.ALEXA_TOKEN_EXPIRES_IN||"86400",10),p=new Date(Date.now()+1e3*h),{error:g}=await d.from("oauth_access_tokens").insert({token:_,user_id:e,client_id:r,scope:t,expires_at:p.toISOString(),revoked:!1});if(g)throw console.error("[OAuth] Error storing access token:",g),Error("Failed to store access token");if(console.log("[OAuth] Issued opaque access token for user:",e,"expires:",p.toISOString()),i){c=s().randomBytes(32).toString("base64url");let{error:t}=await d.from("oauth_refresh_tokens").insert({token:c,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),c=void 0)}return{access_token:_,expires_in:h,refresh_token:c}}async function l(e){let r=(0,n.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function _(e){let r=(0,n.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");i&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function h(e){let r=(0,n.createServerClient)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function p(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>i});var o=t(2851);let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!n)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(s.includes("supabase.com/dashboard")||s.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${s}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e,{db:{schema:"public"}})}(0,o.createClient)(s,n,{db:{schema:"public"}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851],()=>t(1983));module.exports=o})();