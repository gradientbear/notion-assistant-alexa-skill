"use strict";(()=>{var e={};e.id=867,e.ids=[867],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},1983:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var o={};t.r(o),t.d(o,{POST:()=>d,dynamic:()=>l});var n=t(3277),s=t(5265),i=t(5356),a=t(7076),c=t(8675),u=t(1570);let l="force-dynamic";async function d(e){try{let r;console.log("[OAuth Token] Full request:",{url:e.url,method:e.method,contentType:e.headers.get("content-type"),headers:Object.fromEntries(e.headers.entries())});let t=e.headers.get("content-type");if(t?.includes("application/x-www-form-urlencoded")){let t=await e.formData();r=Object.fromEntries(t.entries()),console.log("[OAuth Token] Parsed form data:",Object.keys(r))}else r=await e.json(),console.log("[OAuth Token] Parsed JSON body:",Object.keys(r));let o=r.grant_type,n=r.client_id?.trim(),s=r.client_secret?.trim(),i=process.env.ALEXA_OAUTH_CLIENT_ID?.trim(),l=process.env.ALEXA_OAUTH_CLIENT_SECRET?.trim();if(console.log("[OAuth Token] Client validation:",{clientIdReceived:n?`${n.substring(0,8)}...`:"missing",clientIdExpected:i?`${i.substring(0,8)}...`:"missing",clientSecretReceived:s?"***":"missing",clientSecretExpected:l?"***":"missing",clientIdMatch:n===i,hasClientIdEnv:!!i,hasClientSecretEnv:!!l}),!n)return a.NextResponse.json({error:"invalid_client",error_description:"Missing client_id parameter"},{status:401});if(!i)return console.error("[OAuth Token] ALEXA_OAUTH_CLIENT_ID environment variable is not set"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});if(n!==i)return console.error("[OAuth Token] Client ID mismatch"),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_id"},{status:401});if(!s)return a.NextResponse.json({error:"invalid_client",error_description:"Missing client_secret parameter"},{status:401});if(!l)return console.error("[OAuth Token] ALEXA_OAUTH_CLIENT_SECRET environment variable is not set"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});if(s!==l)return console.error("[OAuth Token] Client secret mismatch"),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_secret"},{status:401});if("authorization_code"===o){let e=r.code,t=r.redirect_uri,o=r.code_verifier;if(!e||!t)return a.NextResponse.json({error:"invalid_request",error_description:"Missing code or redirect_uri"},{status:400});let s=await (0,c.gJ)(e,n,t,o);if(!s)return a.NextResponse.json({error:"invalid_grant",error_description:"Invalid or expired authorization code"},{status:400});let i=(0,u.l)(),{data:l,error:d}=await i.from("users").select("*").eq("id",s.userId).single();if(d||!l)return a.NextResponse.json({error:"server_error",error_description:"User not found"},{status:500});let p=await (0,c.yh)(l.id,n,s.scope,l.tasks_db_id||void 0,l.amazon_account_id||void 0);return console.log("[OAuth Token] Issued token for user:",l.id),a.NextResponse.json({access_token:p.access_token,token_type:"Bearer",expires_in:p.expires_in,refresh_token:p.refresh_token,scope:s.scope})}if("refresh_token"!==o)return a.NextResponse.json({error:"unsupported_grant_type",error_description:`Grant type "${o}" is not supported`},{status:400});if(!r.refresh_token)return a.NextResponse.json({error:"invalid_request",error_description:"Missing refresh_token"},{status:400});return a.NextResponse.json({error:"unsupported_grant_type",error_description:"Refresh token grant not yet implemented"},{status:400})}catch(e){return console.error("[OAuth Token] Error:",e),a.NextResponse.json({error:"server_error",error_description:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/oauth/token/route",pathname:"/api/oauth/token",filename:"route",bundlePath:"app/api/oauth/token/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\token\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:f}=p,m="/api/oauth/token/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},2740:(e,r,t)=>{t.d(r,{A$:()=>u,ez:()=>l,kM:()=>d,lV:()=>p});var o=t(8415),n=t.n(o);let s=process.env.JWT_SECRET||"",i=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),a=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function c(){if(!s)throw Error("JWT_SECRET environment variable is required");return s}function u(e){let r=Math.floor(Date.now()/1e3),t={iss:a,sub:e.userId,email:e.email,iat:r,exp:r+i,scope:e.scope||"alexa",notion_db_id:e.notionDbId,amazon_account_id:e.amazonAccountId};return n().sign(t,c(),{algorithm:"HS256"})}function l(e){try{return n().verify(e,c(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function d(e){try{let r=Buffer.from(e,"base64").toString("utf-8"),t=JSON.parse(r);return"object"==typeof t&&(t.amazon_account_id||t.email||t.timestamp)&&!t.iss}catch{return!1}}function p(e){try{let r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch{return null}}},8675:(e,r,t)=>{t.d(r,{$B:()=>_,Gc:()=>u,PX:()=>p,S5:()=>f,Sv:()=>c,gJ:()=>l,rG:()=>h,yh:()=>d});var o=t(4770),n=t.n(o),s=t(1570),i=t(2740);let a="true"===process.env.REFRESH_TOKEN_ENABLED;function c(){return n().randomBytes(32).toString("base64url")}async function u(e,r,t,o,n="alexa",i,a){let c=(0,s.l)(),u=new Date(Date.now()+6e5),{error:l}=await c.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:n,code_challenge:i,code_challenge_method:a,expires_at:u.toISOString()});if(l)throw console.error("[OAuth] Error storing auth code:",l),Error("Failed to store authorization code")}async function l(e,r,t,o){let i=(0,s.l)(),{data:a,error:c}=await i.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();return c||!a?(console.warn("[OAuth] Invalid authorization code:",e),null):new Date(a.expires_at)<new Date?(console.warn("[OAuth] Authorization code expired"),null):a.used?(console.warn("[OAuth] Authorization code already used"),null):a.code_challenge&&o&&n().createHash("sha256").update(o).digest("base64url")!==a.code_challenge?(console.warn("[OAuth] PKCE code verifier mismatch"),null):(await i.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e),{userId:a.user_id,scope:a.scope})}async function d(e,r,t,o,c){let u;let l=(0,s.l)(),{data:d,error:p}=await l.from("users").select("email, auth_user_id").eq("id",e).single();if(p||!d)throw Error("User not found");let _=(0,i.A$)({userId:d.auth_user_id||e,email:d.email,scope:t,notionDbId:o,amazonAccountId:c}),h=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),f=new Date(Date.now()+1e3*h),{error:m}=await l.from("oauth_access_tokens").insert({token:_,user_id:e,client_id:r,scope:t,expires_at:f.toISOString(),revoked:!1});if(m)throw console.error("[OAuth] Error storing access token:",m),Error("Failed to store access token");if(a){u=n().randomBytes(32).toString("base64url");let{error:t}=await l.from("oauth_refresh_tokens").insert({token:u,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),u=void 0)}return{access_token:_,expires_in:h,refresh_token:u}}async function p(e){let r=(0,s.l)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function _(e){let r=(0,s.l)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");a&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function h(e){let r=(0,s.l)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function f(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{l:()=>i});var o=t(2851);let n="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!n||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(n.includes("supabase.com/dashboard")||n.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${n}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e)}(0,o.createClient)(n,s)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851,415],()=>t(1983));module.exports=o})();