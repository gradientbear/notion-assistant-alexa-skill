"use strict";(()=>{var e={};e.id=959,e.ids=[959],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},6985:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>A,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var o={};t.r(o),t.d(o,{GET:()=>p,dynamic:()=>h});var n=t(3277),s=t(5265),i=t(5356),a=t(7076),u=t(1570),c=t(8675),l=t(2740),d=t(2851);let h="force-dynamic";async function p(e){try{let r=e.nextUrl.searchParams;console.log("[OAuth Authorize] Request received:",{url:e.url,method:e.method,searchParams:Object.fromEntries(r.entries())});let t=r.get("response_type"),o=r.get("client_id")?.trim(),n=r.get("redirect_uri"),s=r.get("scope")||"alexa",i=r.get("state"),h=r.get("code_challenge"),p=r.get("code_challenge_method")||"S256";if("code"!==t)return a.NextResponse.json({error:"unsupported_response_type",error_description:'Only "code" response type is supported'},{status:400});let _=process.env.ALEXA_OAUTH_CLIENT_ID?.trim();if(!o||!_||o!==_)return console.error("[OAuth Authorize] Invalid client_id"),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_id"},{status:400});if(!n||!(0,c.S5)(n))return a.NextResponse.json({error:"invalid_request",error_description:"Invalid or not allowed redirect_uri"},{status:400});console.log("[OAuth Authorize] Step 1: Authenticating user...");let m="https://mwvurelnhrcbtpjtsiyb.supabase.co",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!m||!g)return console.error("[OAuth Authorize] Missing Supabase environment variables"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});let f=r.get("_session_token"),A=e.headers.get("authorization"),v=A?.replace("Bearer ","")||f;if(!v){console.log("[OAuth Authorize] No session token found, redirecting to login");let r=new URL("/?redirect="+encodeURIComponent(e.url),e.url);return a.NextResponse.redirect(r)}let S=null,I=null,k=(0,l.SK)(v);if(k)S=k.sub,I=k.email,console.log("[OAuth Authorize] Authenticated via website JWT:",{auth_user_id:S});else{let r=(0,d.createClient)(m,g),{data:{user:t},error:o}=await r.auth.getUser(v);if(o||!t){console.log("[OAuth Authorize] Invalid session token, redirecting to login:",o?.message);let r=new URL("/?redirect="+encodeURIComponent(e.url),e.url);return a.NextResponse.redirect(r)}S=t.id,I=t.email||null,console.log("[OAuth Authorize] Authenticated via Supabase session token:",{auth_user_id:S})}if(!S){console.log("[OAuth Authorize] No auth_user_id found, redirecting to login");let r=new URL("/?redirect="+encodeURIComponent(e.url),e.url);return a.NextResponse.redirect(r)}console.log("[OAuth Authorize] Step 2: Looking up user in database...");let E=(0,u.createServerClient)(),{data:w,error:b}=await E.from("users").select("*").eq("id",S).single();if(b||!w)return console.error("[OAuth Authorize] User not found in database:",{id:S,email:I,error:b}),a.NextResponse.json({error:"user_not_found",error_description:"User account does not exist. Please sign in again."},{status:400});if(console.log("[OAuth Authorize] User found:",{user_id:w.id}),console.log("[OAuth Authorize] User validated successfully:",{user_id:w.id,email:w.email,has_notion_token:!!w.notion_token,notion_setup_complete:w.notion_setup_complete}),console.log("[OAuth Authorize] Step 4: Checking license status..."),process.env.SKIP_LICENSE_CHECK,console.log("[OAuth Authorize] License check skipped (development/test mode)"),console.log("[OAuth Authorize] Step 5: Checking Notion connection..."),!w.notion_setup_complete||!w.notion_token){console.warn("[OAuth Authorize] Notion not connected:",{notion_setup_complete:w.notion_setup_complete,has_notion_token:!!w.notion_token,user_id:w.id});let r=new URL("/error",e.url);return r.searchParams.set("message","Please connect your Notion account first. Go to onboarding and complete the Notion connection step."),r.searchParams.set("action","notion"),a.NextResponse.redirect(r)}console.log("[OAuth Authorize] Notion connection validated"),console.log("[OAuth Authorize] Step 6: Generating authorization code...");let O=(0,c.Sv)();try{await (0,c.Gc)(O,w.id,o,n,s,h||void 0,"S256"!==p?void 0:p),console.log("[OAuth Authorize] Authorization code stored successfully")}catch(e){return console.error("[OAuth Authorize] Failed to store authorization code:",{error:e.message,user_id:w.id}),a.NextResponse.json({error:"server_error",error_description:"Failed to generate authorization code"},{status:500})}console.log("[OAuth Authorize] Step 7: Redirecting to Alexa...");let z=new URL(n);return z.searchParams.set("code",O),i&&z.searchParams.set("state",i),console.log("[OAuth Authorize] Account linking successful:",{user_id:w.id,email:w.email,redirect_uri:n}),a.NextResponse.redirect(z)}catch(e){return console.error("[OAuth Authorize] Unexpected error:",{error:e,error_message:e?.message,error_stack:e?.stack}),a.NextResponse.json({error:"server_error",error_description:"Internal server error"},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/oauth/authorize/route",pathname:"/api/oauth/authorize",filename:"route",bundlePath:"app/api/oauth/authorize/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\authorize\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f}=_,A="/api/oauth/authorize/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},2740:(e,r,t)=>{t.d(r,{F4:()=>_,SK:()=>p,WJ:()=>h,ez:()=>c,kM:()=>l,lV:()=>d});var o=t(8415),n=t.n(o);let s=process.env.JWT_SECRET||"",i=(parseInt(process.env.JWT_EXPIRES_IN||"3600",10),parseInt(process.env.WEBSITE_JWT_EXPIRES_IN||"3600",10)),a=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function u(){if(!s)throw Error("JWT_SECRET environment variable is required");return s}function c(e){try{return n().verify(e,u(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function l(e){try{let r=Buffer.from(e,"base64").toString("utf-8"),t=JSON.parse(r);return"object"==typeof t&&(t.amazon_account_id||t.email||t.timestamp)&&!t.iss}catch{return!1}}function d(e){try{let r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch{return null}}function h(e){let r=Math.floor(Date.now()/1e3),t={iss:a,sub:e.userId,email:e.email,iat:r,exp:r+i,type:"website_session"};return n().sign(t,u(),{algorithm:"HS256"})}function p(e){try{let r=n().verify(e,u(),{algorithms:["HS256"]});if("website_session"!==r.type)return console.warn("[JWT] Token is not a website session token"),null;return r}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Website token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid website token:",e.message):console.error("[JWT] Website token verification error:",e),null}}async function _(e,r){let o=await Promise.resolve().then(t.t.bind(t,4770,23)),{createServerClient:n}=await Promise.resolve().then(t.bind(t,1570)),s=h({userId:e,email:r}),a=o.randomBytes(32).toString("base64url"),u=new Date(Date.now()+6048e5),c=n(),{error:l}=await c.from("website_refresh_tokens").insert({token:a,user_id:e,expires_at:u.toISOString(),revoked:!1});if(l)throw console.error("[JWT] Error storing refresh token:",l),Error("Failed to store refresh token");return{accessToken:s,refreshToken:a,expiresIn:i}}},8675:(e,r,t)=>{t.d(r,{$B:()=>h,Gc:()=>u,PX:()=>d,S5:()=>_,Sv:()=>a,gJ:()=>c,rG:()=>p,yh:()=>l});var o=t(4770),n=t.n(o),s=t(1570);let i="true"===process.env.REFRESH_TOKEN_ENABLED;function a(){return n().randomBytes(32).toString("base64url")}async function u(e,r,t,o,n="alexa",i,a){let u=(0,s.createServerClient)(),c=new Date(Date.now()+6e5),{data:l,error:d}=await u.from("users").select("id").eq("id",r).single();if(d||!l)throw console.error("[OAuth] User does not exist when storing auth code:",{user_id:r,error:d,user_found:!!l}),Error(`User ${r} does not exist in database`);let{error:h}=await u.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:n,code_challenge:i,code_challenge_method:a,expires_at:c.toISOString()});if(h)throw console.error("[OAuth] Error storing auth code:",{error_code:h.code,error_message:h.message,error_details:h.details,error_hint:h.hint,user_id:r,user_exists:!!l}),Error(`Failed to store authorization code: ${h.message}`)}async function c(e,r,t,o){let i=(0,s.createServerClient)();try{let{data:s,error:a}=await i.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();if(a||!s)return console.warn("[OAuth] Invalid authorization code:",{code_preview:e?e.substring(0,10)+"...":"missing",client_id:r,redirect_uri:t,error:a,error_code:a?.code,error_message:a?.message}),null;if(new Date(s.expires_at)<new Date)return console.warn("[OAuth] Authorization code expired:",{expires_at:s.expires_at,now:new Date().toISOString()}),null;if(s.used)return console.warn("[OAuth] Authorization code already used:",{code_preview:e.substring(0,10)+"...",used_at:s.used_at}),null;if(s.code_challenge&&o&&n().createHash("sha256").update(o).digest("base64url")!==s.code_challenge)return console.warn("[OAuth] PKCE code verifier mismatch"),null;let{error:u}=await i.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e);return u&&console.error("[OAuth] Failed to mark authorization code as used:",{error:u,error_code:u.code,error_message:u.message}),{userId:s.user_id,scope:s.scope}}catch(e){return console.error("[OAuth] Error validating authorization code:",{error:e,error_message:e?.message,error_stack:e?.stack}),null}}async function l(e,r,t,o,a){let u;let c=(0,s.createServerClient)(),{data:l,error:d}=await c.from("users").select("email").eq("id",e).single();if(d||!l)throw Error("User not found");let h=n().randomBytes(32).toString("base64url"),p=parseInt(process.env.ALEXA_TOKEN_EXPIRES_IN||"86400",10),_=new Date(Date.now()+1e3*p),{error:m}=await c.from("oauth_access_tokens").insert({token:h,user_id:e,client_id:r,scope:t,expires_at:_.toISOString(),revoked:!1});if(m)throw console.error("[OAuth] Error storing access token:",m),Error("Failed to store access token");if(console.log("[OAuth] Issued opaque access token for user:",e,"expires:",_.toISOString()),i){u=n().randomBytes(32).toString("base64url");let{error:t}=await c.from("oauth_refresh_tokens").insert({token:u,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),u=void 0)}return{access_token:h,expires_in:p,refresh_token:u}}async function d(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function h(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");i&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function p(e){let r=(0,s.createServerClient)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function _(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>i});var o=t(2851);let n="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!n||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(n.includes("supabase.com/dashboard")||n.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${n}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e,{db:{schema:"public"}})}(0,o.createClient)(n,s,{db:{schema:"public"}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851,415],()=>t(6985));module.exports=o})();