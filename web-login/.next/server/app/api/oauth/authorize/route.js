"use strict";(()=>{var e={};e.id=959,e.ids=[959],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},6985:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>h,serverHooks:()=>m,staticGenerationAsyncStorage:()=>_});var o={};t.r(o),t.d(o,{GET:()=>d,dynamic:()=>l});var s=t(3277),n=t(5265),i=t(5356),a=t(7076),u=t(1570),c=t(8675);let l="force-dynamic";async function d(e){try{let r=e.nextUrl.searchParams;console.log("[OAuth Authorize] Full request:",{url:e.url,method:e.method,headers:Object.fromEntries(e.headers.entries()),searchParams:Object.fromEntries(r.entries())});let o=r.get("response_type"),s=r.get("client_id")?.trim(),n=r.get("redirect_uri"),i=r.get("scope")||"alexa",l=r.get("state"),d=r.get("code_challenge"),h=r.get("code_challenge_method")||"S256";if("code"!==o)return a.NextResponse.json({error:"unsupported_response_type",error_description:'Only "code" response type is supported'},{status:400});let p=process.env.ALEXA_OAUTH_CLIENT_ID?.trim();if(console.log("[OAuth Authorize] Client ID validation:",{received:s?`${s.substring(0,8)}...`:"missing",receivedLength:s?.length||0,expected:p?`${p.substring(0,8)}...`:"missing",expectedLength:p?.length||0,match:s===p,hasEnvVar:!!p,receivedFirstChar:s?.[0],receivedLastChar:s?.[s.length-1],expectedFirstChar:p?.[0],expectedLastChar:p?.[p.length-1]}),!s)return a.NextResponse.json({error:"invalid_client",error_description:"Missing client_id parameter"},{status:400});if(!p)return console.error("[OAuth Authorize] ALEXA_OAUTH_CLIENT_ID environment variable is not set"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});if(s!==p)return console.error("[OAuth Authorize] Client ID mismatch:",{received:s,expected:p}),a.NextResponse.json({error:"invalid_client",error_description:"Invalid client_id"},{status:400});if(!n||!(0,c.S5)(n))return a.NextResponse.json({error:"invalid_request",error_description:"Invalid or not allowed redirect_uri"},{status:400});let _="https://mwvurelnhrcbtpjtsiyb.supabase.co",m=_.split("//")[1]?.split(".")[0]||"default",g=`sb-${m}-auth-token`,f=e.headers.get("authorization"),v=f?.replace("Bearer ","");if(v||(v=e.cookies.get("sb-access-token")?.value||e.cookies.get(g)?.value||e.cookies.get(`sb-${m}-auth-token`)?.value),console.log("[OAuth Authorize] Session check:",{hasAuthHeader:!!f,hasAccessTokenCookie:!!e.cookies.get("sb-access-token")?.value,hasProjectCookie:!!e.cookies.get(g)?.value,cookieName:g,hasSessionToken:!!v}),!v){console.log("[OAuth Authorize] No session token found, redirecting to login");let r=new URL("/?redirect="+encodeURIComponent(e.url),e.url);return a.NextResponse.redirect(r)}let A="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!A||!_)return console.error("[OAuth Authorize] Missing Supabase environment variables"),a.NextResponse.json({error:"server_error",error_description:"Server configuration error"},{status:500});let{createClient:I}=await Promise.resolve().then(t.bind(t,2851)),k=I(_,A),{data:{user:E},error:S}=await k.auth.getUser(v);if(S||!E){console.log("[OAuth Authorize] Invalid session token, redirecting to login:",S?.message);let r=new URL("/?redirect="+encodeURIComponent(e.url),e.url);return a.NextResponse.redirect(r)}console.log("[OAuth Authorize] User authenticated:",E.id,E.email);let w=(0,u.l)(),{data:b,error:x}=await w.from("users").select("*").eq("auth_user_id",E.id),z=null;if(b&&b.length>0){let e=b.find(e=>!!e.notion_token);e?(z=e,console.log("[OAuth Authorize] Selected user with Notion token:",z.id)):(z=b.sort((e,r)=>new Date(r.updated_at||r.created_at).getTime()-new Date(e.updated_at||e.created_at).getTime())[0],console.log("[OAuth Authorize] Selected most recently updated user:",z.id)),b.length>1&&console.warn("[OAuth Authorize] ⚠️ Multiple users found with same auth_user_id!",{total_users:b.length,selected_user_id:z.id}),x=null}if(x||!z)return console.error("[OAuth Authorize] User not found:",{auth_user_id:E.id,error:x,usersFound:b?.length||0}),a.NextResponse.json({error:"server_error",error_description:"User not found"},{status:500});if("true"===process.env.SKIP_LICENSE_CHECK)console.log("[OAuth Authorize] License check skipped (development/test mode)");else{let{data:r,error:t}=await w.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",z.id).eq("revoked",!1).gt("expires_at",new Date().toISOString()).limit(1).maybeSingle();t&&console.error("[OAuth Authorize] Error checking for JWT token:",t);let o=!!r,s=!1;if(z.license_key){let{data:e,error:r}=await w.from("licenses").select("status").eq("license_key",z.license_key).single();!r&&e&&"active"===e.status&&(s=!0)}if(!o&&!s){let r=new URL("/error",e.url);return r.searchParams.set("message","Please purchase a license to link your Alexa account."),r.searchParams.set("action","purchase"),a.NextResponse.redirect(r)}console.log("[OAuth Authorize] License validation passed:",{hasActiveToken:o,hasActiveLicense:s})}if(!z.notion_setup_complete||!z.notion_token){let r=new URL("/error",e.url);return r.searchParams.set("message","Please connect your Notion account first. Go to onboarding and complete the Notion connection step."),r.searchParams.set("action","notion"),a.NextResponse.redirect(r)}let O=(0,c.Sv)();await (0,c.Gc)(O,z.id,s,n,i,d||void 0,"S256"!==h?void 0:h);let R=new URL(n);return R.searchParams.set("code",O),l&&R.searchParams.set("state",l),console.log("[OAuth Authorize] Issued code for user:",z.id,"redirect:",n),a.NextResponse.redirect(R)}catch(e){return console.error("[OAuth Authorize] Error:",e),a.NextResponse.json({error:"server_error",error_description:"Internal server error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/oauth/authorize/route",pathname:"/api/oauth/authorize",filename:"route",bundlePath:"app/api/oauth/authorize/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\oauth\\authorize\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:_,serverHooks:m}=h,g="/api/oauth/authorize/route";function f(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:_})}},2740:(e,r,t)=>{t.d(r,{A$:()=>c,ez:()=>l,kM:()=>d,lV:()=>h});var o=t(8415),s=t.n(o);let n=process.env.JWT_SECRET||"",i=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),a=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function u(){if(!n)throw Error("JWT_SECRET environment variable is required");return n}function c(e){let r=Math.floor(Date.now()/1e3),t={iss:a,sub:e.userId,email:e.email,iat:r,exp:r+i,scope:e.scope||"alexa",notion_db_id:e.notionDbId,amazon_account_id:e.amazonAccountId};return s().sign(t,u(),{algorithm:"HS256"})}function l(e){try{return s().verify(e,u(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function d(e){try{let r=Buffer.from(e,"base64").toString("utf-8"),t=JSON.parse(r);return"object"==typeof t&&(t.amazon_account_id||t.email||t.timestamp)&&!t.iss}catch{return!1}}function h(e){try{let r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch{return null}}},8675:(e,r,t)=>{t.d(r,{$B:()=>p,Gc:()=>c,PX:()=>h,S5:()=>m,Sv:()=>u,gJ:()=>l,rG:()=>_,yh:()=>d});var o=t(4770),s=t.n(o),n=t(1570),i=t(2740);let a="true"===process.env.REFRESH_TOKEN_ENABLED;function u(){return s().randomBytes(32).toString("base64url")}async function c(e,r,t,o,s="alexa",i,a){let u=(0,n.l)(),c=new Date(Date.now()+6e5),{error:l}=await u.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:s,code_challenge:i,code_challenge_method:a,expires_at:c.toISOString()});if(l)throw console.error("[OAuth] Error storing auth code:",l),Error("Failed to store authorization code")}async function l(e,r,t,o){let i=(0,n.l)(),{data:a,error:u}=await i.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();return u||!a?(console.warn("[OAuth] Invalid authorization code:",e),null):new Date(a.expires_at)<new Date?(console.warn("[OAuth] Authorization code expired"),null):a.used?(console.warn("[OAuth] Authorization code already used"),null):a.code_challenge&&o&&s().createHash("sha256").update(o).digest("base64url")!==a.code_challenge?(console.warn("[OAuth] PKCE code verifier mismatch"),null):(await i.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e),{userId:a.user_id,scope:a.scope})}async function d(e,r,t,o,u){let c;let l=(0,n.l)(),{data:d,error:h}=await l.from("users").select("email, auth_user_id").eq("id",e).single();if(h||!d)throw Error("User not found");let p=(0,i.A$)({userId:d.auth_user_id||e,email:d.email,scope:t,notionDbId:o,amazonAccountId:u}),_=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),m=new Date(Date.now()+1e3*_),{error:g}=await l.from("oauth_access_tokens").insert({token:p,user_id:e,client_id:r,scope:t,expires_at:m.toISOString(),revoked:!1});if(g)throw console.error("[OAuth] Error storing access token:",g),Error("Failed to store access token");if(a){c=s().randomBytes(32).toString("base64url");let{error:t}=await l.from("oauth_refresh_tokens").insert({token:c,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),c=void 0)}return{access_token:p,expires_in:_,refresh_token:c}}async function h(e){let r=(0,n.l)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function p(e){let r=(0,n.l)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");a&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function _(e){let r=(0,n.l)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function m(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{l:()=>i});var o=t(2851);let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!n)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(s.includes("supabase.com/dashboard")||s.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${s}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e)}(0,o.createClient)(s,n)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851,415],()=>t(6985));module.exports=o})();