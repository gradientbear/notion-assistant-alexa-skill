"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},1764:e=>{e.exports=require("util")},6507:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>f,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>k,staticGenerationAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{POST:()=>p,dynamic:()=>d});var a=t(3277),s=t(5265),i=t(5356),n=t(7076),c=t(8915),u=t(8675),l=t(1570);let d="force-dynamic";async function p(e){try{let r=await e.text(),t=e.headers.get("stripe-signature");if(!t)return n.NextResponse.json({error:"Missing stripe-signature header"},{status:400});let o=(0,c.po)(r,t);if(!o)return n.NextResponse.json({error:"Invalid signature"},{status:400});let a=(0,l.createServerClient)();switch(o.type){case"payment_intent.succeeded":{let e=o.data.object,r=e.metadata?.user_id,t=e.id;if(!r){console.error("[Stripe Webhook] Missing user_id in payment intent metadata");break}let{data:s,error:i}=await a.from("users").select("id, email").eq("id",r).single();if(i||!s){console.error("[Stripe Webhook] User not found:",r);break}let{error:n}=await a.from("licenses").upsert({stripe_payment_intent_id:t,license_key:t,status:"active",stripe_customer_id:e.customer||null,amount_paid:e.amount?e.amount/100:null,currency:e.currency||"usd",purchase_date:new Date().toISOString(),updated_at:new Date().toISOString()},{onConflict:"stripe_payment_intent_id"});n?console.error("[Stripe Webhook] Error creating/updating license:",n):console.log("[Stripe Webhook] License activated:",t);let{error:c}=await a.from("users").update({license_key:t}).eq("id",r);c&&console.error("[Stripe Webhook] Error updating user license_key:",c);try{let e=process.env.ALEXA_OAUTH_CLIENT_ID||"voice-planner";await (0,u.yh)(r,e,"alexa"),console.log("[Stripe Webhook] Generated opaque token for user:",r)}catch(e){console.error("[Stripe Webhook] Error generating token:",e)}break}case"charge.refunded":case"payment_intent.canceled":{let e=o.data.object,r=e.id||e.payment_intent?.id,t=e.metadata?.user_id||e.payment_intent?.metadata?.user_id;if(r){let{error:e}=await a.from("licenses").update({status:"inactive",updated_at:new Date().toISOString()}).eq("stripe_payment_intent_id",r);if(e?console.error("[Stripe Webhook] Error deactivating license:",e):console.log("[Stripe Webhook] License deactivated:",r),t)try{await (0,u.$B)(t),console.log("[Stripe Webhook] Tokens revoked for user:",t)}catch(e){console.error("[Stripe Webhook] Error revoking tokens:",e)}else{let{data:e}=await a.from("users").select("id").eq("license_key",r);if(e)for(let r of e)try{await (0,u.$B)(r.id)}catch(e){console.error("[Stripe Webhook] Error revoking tokens for user:",r.id,e)}}await a.from("users").update({license_key:null}).eq("license_key",r)}break}case"payment_intent.payment_failed":{let e=o.data.object;console.log("[Stripe Webhook] Payment failed:",e.id);break}default:console.log("[Stripe Webhook] Unhandled event type:",o.type)}return n.NextResponse.json({received:!0})}catch(e){return console.error("[Stripe Webhook] Error:",e),n.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:k}=_,S="/api/webhooks/stripe/route";function f(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:m})}},8675:(e,r,t)=>{t.d(r,{$B:()=>p,Gc:()=>c,PX:()=>d,S5:()=>h,Sv:()=>n,gJ:()=>u,rG:()=>_,yh:()=>l});var o=t(4770),a=t.n(o),s=t(1570);let i="true"===process.env.REFRESH_TOKEN_ENABLED;function n(){return a().randomBytes(32).toString("base64url")}async function c(e,r,t,o,a="alexa",i,n){let c=(0,s.createServerClient)(),u=new Date(Date.now()+6e5),{data:l,error:d}=await c.from("users").select("id").eq("id",r).single();if(d||!l)throw console.error("[OAuth] User does not exist when storing auth code:",{user_id:r,error:d,user_found:!!l}),Error(`User ${r} does not exist in database`);let{error:p}=await c.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:a,code_challenge:i,code_challenge_method:n,expires_at:u.toISOString()});if(p)throw console.error("[OAuth] Error storing auth code:",{error_code:p.code,error_message:p.message,error_details:p.details,error_hint:p.hint,user_id:r,user_exists:!!l}),Error(`Failed to store authorization code: ${p.message}`)}async function u(e,r,t,o){let i=(0,s.createServerClient)();try{let{data:s,error:n}=await i.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();if(n||!s)return console.warn("[OAuth] Invalid authorization code:",{code_preview:e?e.substring(0,10)+"...":"missing",client_id:r,redirect_uri:t,error:n,error_code:n?.code,error_message:n?.message}),null;if(new Date(s.expires_at)<new Date)return console.warn("[OAuth] Authorization code expired:",{expires_at:s.expires_at,now:new Date().toISOString()}),null;if(s.used)return console.warn("[OAuth] Authorization code already used:",{code_preview:e.substring(0,10)+"...",used_at:s.used_at}),null;if(s.code_challenge&&o&&a().createHash("sha256").update(o).digest("base64url")!==s.code_challenge)return console.warn("[OAuth] PKCE code verifier mismatch"),null;let{error:c}=await i.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e);return c&&console.error("[OAuth] Failed to mark authorization code as used:",{error:c,error_code:c.code,error_message:c.message}),{userId:s.user_id,scope:s.scope}}catch(e){return console.error("[OAuth] Error validating authorization code:",{error:e,error_message:e?.message,error_stack:e?.stack}),null}}async function l(e,r,t,o,n){let c;let u=(0,s.createServerClient)(),{data:l,error:d}=await u.from("users").select("email").eq("id",e).single();if(d||!l)throw Error("User not found");let p=a().randomBytes(32).toString("base64url"),_=parseInt(process.env.ALEXA_TOKEN_EXPIRES_IN||"86400",10),h=new Date(Date.now()+1e3*_),{error:m}=await u.from("oauth_access_tokens").insert({token:p,user_id:e,client_id:r,scope:t,expires_at:h.toISOString(),revoked:!1});if(m)throw console.error("[OAuth] Error storing access token:",m),Error("Failed to store access token");if(console.log("[OAuth] Issued opaque access token for user:",e,"expires:",h.toISOString()),i){c=a().randomBytes(32).toString("base64url");let{error:t}=await u.from("oauth_refresh_tokens").insert({token:c,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),c=void 0)}return{access_token:p,expires_in:_,refresh_token:c}}async function d(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function p(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");i&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function _(e){let r=(0,s.createServerClient)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function h(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},8915:(e,r,t)=>{t.d(r,{Mc:()=>c,po:()=>n});var o=t(7284);let a=process.env.STRIPE_SECRET_KEY||"",s=process.env.STRIPE_WEBHOOK_SECRET||"";a||console.warn("[Stripe] STRIPE_SECRET_KEY not set. Stripe features will be disabled.");let i=a?new o.Z(a):null;function n(e,r){if(!i||!s)throw Error("Stripe not configured");try{return i.webhooks.constructEvent(e,r,s)}catch(e){return console.error("[Stripe] Webhook signature verification failed:",e.message),null}}async function c(e){if(!i)throw Error("Stripe not configured");try{return await i.checkout.sessions.create({mode:"payment",payment_method_types:["card"],line_items:[{price:e.priceId,quantity:1}],success_url:e.successUrl,cancel_url:e.cancelUrl,customer_email:e.customerEmail,metadata:e.metadata||{}})}catch(e){throw console.error("[Stripe] Error creating checkout session:",e),e}}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>i});var o=t(2851);let a="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!a||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(a.includes("supabase.com/dashboard")||a.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${a}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e,{db:{schema:"public"}})}(0,o.createClient)(a,s,{db:{schema:"public"}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851,284],()=>t(6507));module.exports=o})();