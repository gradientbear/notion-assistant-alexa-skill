"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},6507:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>S,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{POST:()=>p,dynamic:()=>d});var a=r(3277),n=r(5265),s=r(5356),i=r(7076),c=r(8915),l=r(8675),u=r(1570);let d="force-dynamic";async function p(e){try{let t=await e.text(),r=e.headers.get("stripe-signature");if(!r)return i.NextResponse.json({error:"Missing stripe-signature header"},{status:400});let o=(0,c.po)(t,r);if(!o)return i.NextResponse.json({error:"Invalid signature"},{status:400});let a=(0,u.l)();switch(o.type){case"payment_intent.succeeded":{let e=o.data.object,t=e.metadata?.license_key;if(e.metadata?.user_id,t){let{error:e}=await a.from("licenses").update({status:"active",updated_at:new Date().toISOString()}).eq("license_key",t);e?console.error("[Stripe Webhook] Error activating license:",e):console.log("[Stripe Webhook] License activated:",t)}break}case"charge.refunded":case"payment_intent.canceled":{let e=o.data.object,t=e.metadata?.license_key||e.payment_intent?.metadata?.license_key,r=e.metadata?.user_id||e.payment_intent?.metadata?.user_id;if(t){let{error:e}=await a.from("licenses").update({status:"inactive",updated_at:new Date().toISOString()}).eq("license_key",t);if(e?console.error("[Stripe Webhook] Error deactivating license:",e):console.log("[Stripe Webhook] License deactivated:",t),r)try{await (0,l.$B)(r),console.log("[Stripe Webhook] Tokens revoked for user:",r)}catch(e){console.error("[Stripe Webhook] Error revoking tokens:",e)}else{let{data:e}=await a.from("users").select("id").eq("license_key",t);if(e)for(let t of e)try{await (0,l.$B)(t.id)}catch(e){console.error("[Stripe Webhook] Error revoking tokens for user:",t.id,e)}}}break}case"payment_intent.payment_failed":{let e=o.data.object;console.log("[Stripe Webhook] Payment failed:",e.id);break}default:console.log("[Stripe Webhook] Unhandled event type:",o.type)}return i.NextResponse.json({received:!0})}catch(e){return console.error("[Stripe Webhook] Error:",e),i.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:f}=h,k="/api/webhooks/stripe/route";function S(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2740:(e,t,r)=>{r.d(t,{A$:()=>l,ez:()=>u,kM:()=>d,lV:()=>p});var o=r(8415),a=r.n(o);let n=process.env.JWT_SECRET||"",s=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),i=process.env.APP_ISS||"https://notion-data-user.vercel.app";function c(){if(!n)throw Error("JWT_SECRET environment variable is required");return n}function l(e){let t=Math.floor(Date.now()/1e3),r={iss:i,sub:e.userId,email:e.email,iat:t,exp:t+s,scope:e.scope||"alexa",notion_db_id:e.notionDbId,amazon_account_id:e.amazonAccountId};return a().sign(r,c(),{algorithm:"HS256"})}function u(e){try{return a().verify(e,c(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function d(e){try{let t=Buffer.from(e,"base64").toString("utf-8"),r=JSON.parse(t);return"object"==typeof r&&(r.amazon_account_id||r.email||r.timestamp)&&!r.iss}catch{return!1}}function p(e){try{let t=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(t)}catch{return null}}},8675:(e,t,r)=>{r.d(t,{$B:()=>h,Gc:()=>l,PX:()=>p,S5:()=>m,Sv:()=>c,gJ:()=>u,rG:()=>_,yh:()=>d});var o=r(4770),a=r.n(o),n=r(1570),s=r(2740);let i="true"===process.env.REFRESH_TOKEN_ENABLED;function c(){return a().randomBytes(32).toString("base64url")}async function l(e,t,r,o,a="alexa",s,i){let c=(0,n.l)(),l=new Date(Date.now()+6e5),{error:u}=await c.from("oauth_authorization_codes").insert({code:e,user_id:t,client_id:r,redirect_uri:o,scope:a,code_challenge:s,code_challenge_method:i,expires_at:l.toISOString()});if(u)throw console.error("[OAuth] Error storing auth code:",u),Error("Failed to store authorization code")}async function u(e,t,r,o){let s=(0,n.l)(),{data:i,error:c}=await s.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",t).eq("redirect_uri",r).single();return c||!i?(console.warn("[OAuth] Invalid authorization code:",e),null):new Date(i.expires_at)<new Date?(console.warn("[OAuth] Authorization code expired"),null):i.used?(console.warn("[OAuth] Authorization code already used"),null):i.code_challenge&&o&&a().createHash("sha256").update(o).digest("base64url")!==i.code_challenge?(console.warn("[OAuth] PKCE code verifier mismatch"),null):(await s.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e),{userId:i.user_id,scope:i.scope})}async function d(e,t,r,o,c){let l;let u=(0,n.l)(),{data:d,error:p}=await u.from("users").select("email, auth_user_id").eq("id",e).single();if(p||!d)throw Error("User not found");let h=(0,s.A$)({userId:d.auth_user_id||e,email:d.email,scope:r,notionDbId:o,amazonAccountId:c}),_=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),m=new Date(Date.now()+1e3*_),{error:f}=await u.from("oauth_access_tokens").insert({token:h,user_id:e,client_id:t,scope:r,expires_at:m.toISOString(),revoked:!1});if(f)throw console.error("[OAuth] Error storing access token:",f),Error("Failed to store access token");if(i){l=a().randomBytes(32).toString("base64url");let{error:r}=await u.from("oauth_refresh_tokens").insert({token:l,user_id:e,client_id:t,revoked:!1});r&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),l=void 0)}return{access_token:h,expires_in:_,refresh_token:l}}async function p(e){let t=(0,n.l)(),{error:r}=await t.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(r)throw console.error("[OAuth] Error revoking token:",r),Error("Failed to revoke token")}async function h(e){let t=(0,n.l)(),{error:r}=await t.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(r)throw console.error("[OAuth] Error revoking user tokens:",r),Error("Failed to revoke user tokens");i&&await t.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function _(e){let t=(0,n.l)(),{data:r,error:o}=await t.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!r||!0===r.revoked}function m(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(t=>e.startsWith(t))}},8915:(e,t,r)=>{r.d(t,{Mc:()=>c,po:()=>i});var o=r(7284);let a=process.env.STRIPE_SECRET_KEY||"",n=process.env.STRIPE_WEBHOOK_SECRET||"";a||console.warn("[Stripe] STRIPE_SECRET_KEY not set. Stripe features will be disabled.");let s=a?new o.Z(a):null;function i(e,t){if(!s||!n)throw Error("Stripe not configured");try{return s.webhooks.constructEvent(e,t,n)}catch(e){return console.error("[Stripe] Webhook signature verification failed:",e.message),null}}async function c(e){if(!s)throw Error("Stripe not configured");try{return await s.checkout.sessions.create({mode:"payment",payment_method_types:["card"],line_items:[{price:e.priceId,quantity:1}],success_url:e.successUrl,cancel_url:e.cancelUrl,customer_email:e.customerEmail,metadata:e.metadata||{}})}catch(e){throw console.error("[Stripe] Error creating checkout session:",e),e}}},1570:(e,t,r)=>{r.d(t,{l:()=>s});var o=r(2851);let a="https://ptasyynqqlvrbhqmtvhl.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0YXN5eW5xcWx2cmJocW10dmhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NzYwODYsImV4cCI6MjA3OTQ1MjA4Nn0.di3Mk3cndlDzjWwUoXcB8DDslyJO-lbsIHtwRKaWCZI";if(!a||!n)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(a.includes("supabase.com/dashboard")||a.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${a}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function s(){let e=process.env.SUPABASE_SERVICE_KEY||"",t="https://ptasyynqqlvrbhqmtvhl.supabase.co";if(!e||!t)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(t,e)}(0,o.createClient)(a,n)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[942,786,851,415,284],()=>r(6507));module.exports=o})();