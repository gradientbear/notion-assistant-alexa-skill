"use strict";(()=>{var e={};e.id=508,e.ids=[508],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},9485:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>k,requestAsyncStorage:()=>p,routeModule:()=>_,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var o={};r.r(o),r.d(o,{POST:()=>c,dynamic:()=>d});var n=r(3277),a=r(5265),s=r(5356),i=r(7076),u=r(1570),l=r(8675);let d="force-dynamic";async function c(e){try{let t=e.headers.get("authorization"),r=t?.replace("Bearer ","")||e.cookies.get("sb-access-token")?.value;if(!r)return i.NextResponse.json({error:"unauthorized",error_description:"Authentication required"},{status:401});let o=(0,u.l)(),{data:{user:n},error:a}=await o.auth.getUser(r);if(a||!n)return i.NextResponse.json({error:"unauthorized",error_description:"Invalid session"},{status:401});let{data:s,error:d}=await o.from("users").select("*").eq("auth_user_id",n.id),c=null;if(s&&s.length>0){let e=s.find(e=>!!e.notion_token);e?(c=e,console.log("[Billing] Selected user with Notion token:",{user_id:c.id,has_notion_token:!0})):(c=s.sort((e,t)=>new Date(t.updated_at||t.created_at).getTime()-new Date(e.updated_at||e.created_at).getTime())[0],console.log("[Billing] Selected most recently updated user:",{user_id:c.id,updated_at:c.updated_at})),s.length>1&&console.warn("[Billing] ⚠️ Multiple users found with same auth_user_id!",{total_users:s.length,selected_user_id:c.id,all_user_ids:s.map(e=>({id:e.id,has_notion_token:!!e.notion_token,updated_at:e.updated_at})),auth_user_id:n.id}),d=null}if(d||!c)return console.error("[Billing] User not found:",{auth_user_id:n.id,error:d,usersFound:s?.length||0}),i.NextResponse.json({error:"server_error",error_description:"User not found"},{status:500});let _=process.env.ALEXA_OAUTH_CLIENT_ID||"alexa";console.log("[Billing] Generating token for user:",{user_id:c.id,auth_user_id:c.auth_user_id,email:c.email,has_tasks_db:!!c.tasks_db_id,has_notion_token:!!c.notion_token,notion_setup_complete:c.notion_setup_complete,matching_auth_user_id:c.auth_user_id===n.id}),c.auth_user_id!==n.id&&console.error("[Billing] ⚠️ WARNING: User auth_user_id mismatch!",{user_auth_user_id:c.auth_user_id,session_auth_user_id:n.id,user_id:c.id});let p=await (0,l.yh)(c.id,_,"alexa",c.tasks_db_id||void 0,c.amazon_account_id||void 0);console.log("[Billing] Token generated successfully:",{user_id:c.id,token_preview:p.access_token.substring(0,20)+"...",expires_in:p.expires_in});let{data:h,error:g}=await o.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",c.id).eq("revoked",!1).order("created_at",{ascending:!1}).limit(1).maybeSingle();return g?console.error("[Billing] Error verifying token storage:",g):h?console.log("[Billing] Token verified in database:",{token_preview:h.token?h.token.substring(0,20)+"...":"null",expires_at:h.expires_at,revoked:h.revoked}):console.warn("[Billing] Token not found in database after generation - might be a timing issue"),i.NextResponse.json({success:!0,message:"JWT token generated successfully",access_token:p.access_token,expires_in:p.expires_in})}catch(e){return console.error("[Billing] Error generating token:",e),i.NextResponse.json({error:"server_error",error_description:e.message||"Internal server error"},{status:500})}}let _=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/billing/generate-test-token/route",pathname:"/api/billing/generate-test-token",filename:"route",bundlePath:"app/api/billing/generate-test-token/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\billing\\generate-test-token\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:g}=_,m="/api/billing/generate-test-token/route";function k(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},2740:(e,t,r)=>{r.d(t,{A$:()=>l,ez:()=>d,kM:()=>c,lV:()=>_});var o=r(8415),n=r.n(o);let a=process.env.JWT_SECRET||"",s=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),i=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function u(){if(!a)throw Error("JWT_SECRET environment variable is required");return a}function l(e){let t=Math.floor(Date.now()/1e3),r={iss:i,sub:e.userId,email:e.email,iat:t,exp:t+s,scope:e.scope||"alexa",notion_db_id:e.notionDbId,amazon_account_id:e.amazonAccountId};return n().sign(r,u(),{algorithm:"HS256"})}function d(e){try{return n().verify(e,u(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function c(e){try{let t=Buffer.from(e,"base64").toString("utf-8"),r=JSON.parse(t);return"object"==typeof r&&(r.amazon_account_id||r.email||r.timestamp)&&!r.iss}catch{return!1}}function _(e){try{let t=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(t)}catch{return null}}},8675:(e,t,r)=>{r.d(t,{$B:()=>p,Gc:()=>l,PX:()=>_,S5:()=>g,Sv:()=>u,gJ:()=>d,rG:()=>h,yh:()=>c});var o=r(4770),n=r.n(o),a=r(1570),s=r(2740);let i="true"===process.env.REFRESH_TOKEN_ENABLED;function u(){return n().randomBytes(32).toString("base64url")}async function l(e,t,r,o,n="alexa",s,i){let u=(0,a.l)(),l=new Date(Date.now()+6e5),{error:d}=await u.from("oauth_authorization_codes").insert({code:e,user_id:t,client_id:r,redirect_uri:o,scope:n,code_challenge:s,code_challenge_method:i,expires_at:l.toISOString()});if(d)throw console.error("[OAuth] Error storing auth code:",d),Error("Failed to store authorization code")}async function d(e,t,r,o){let s=(0,a.l)(),{data:i,error:u}=await s.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",t).eq("redirect_uri",r).single();return u||!i?(console.warn("[OAuth] Invalid authorization code:",e),null):new Date(i.expires_at)<new Date?(console.warn("[OAuth] Authorization code expired"),null):i.used?(console.warn("[OAuth] Authorization code already used"),null):i.code_challenge&&o&&n().createHash("sha256").update(o).digest("base64url")!==i.code_challenge?(console.warn("[OAuth] PKCE code verifier mismatch"),null):(await s.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e),{userId:i.user_id,scope:i.scope})}async function c(e,t,r,o,u){let l;let d=(0,a.l)(),{data:c,error:_}=await d.from("users").select("email, auth_user_id").eq("id",e).single();if(_||!c)throw Error("User not found");let p=(0,s.A$)({userId:c.auth_user_id||e,email:c.email,scope:r,notionDbId:o,amazonAccountId:u}),h=parseInt(process.env.JWT_EXPIRES_IN||"3600",10),g=new Date(Date.now()+1e3*h),{error:m}=await d.from("oauth_access_tokens").insert({token:p,user_id:e,client_id:t,scope:r,expires_at:g.toISOString(),revoked:!1});if(m)throw console.error("[OAuth] Error storing access token:",m),Error("Failed to store access token");if(i){l=n().randomBytes(32).toString("base64url");let{error:r}=await d.from("oauth_refresh_tokens").insert({token:l,user_id:e,client_id:t,revoked:!1});r&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),l=void 0)}return{access_token:p,expires_in:h,refresh_token:l}}async function _(e){let t=(0,a.l)(),{error:r}=await t.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(r)throw console.error("[OAuth] Error revoking token:",r),Error("Failed to revoke token")}async function p(e){let t=(0,a.l)(),{error:r}=await t.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(r)throw console.error("[OAuth] Error revoking user tokens:",r),Error("Failed to revoke user tokens");i&&await t.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function h(e){let t=(0,a.l)(),{data:r,error:o}=await t.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!r||!0===r.revoked}function g(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(t=>e.startsWith(t))}},1570:(e,t,r)=>{r.d(t,{l:()=>s});var o=r(2851);let n="https://mwvurelnhrcbtpjtsiyb.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!n||!a)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(n.includes("supabase.com/dashboard")||n.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${n}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function s(){let e=process.env.SUPABASE_SERVICE_KEY||"",t="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!t)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(t,e)}(0,o.createClient)(n,a)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[942,786,851,415],()=>r(9485));module.exports=o})();