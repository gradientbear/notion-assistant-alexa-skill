"use strict";(()=>{var e={};e.id=655,e.ids=[655],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},7880:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>_,serverHooks:()=>v,staticGenerationAsyncStorage:()=>p});var o={};t.r(o),t.d(o,{POST:()=>l,dynamic:()=>d});var s=t(3277),a=t(5265),n=t(5356),i=t(7076),u=t(8675),c=t(1570);let d="force-dynamic";async function l(e){try{let r=e.headers.get("authorization"),t=process.env.SUPABASE_SERVICE_KEY;if(!r&&!t)return i.NextResponse.json({error:"unauthorized",error_description:"Authorization required"},{status:401});if(!(r?.includes(t||"")||r?.includes("admin")||t))return i.NextResponse.json({error:"unauthorized",error_description:"Insufficient permissions"},{status:403});let{token:o,user_id:s,all:a}=await e.json();if(a&&t){let e=(0,c.createServerClient)(),{error:r}=await e.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("revoked",!1);if(r)throw r;return i.NextResponse.json({success:!0,message:"All tokens revoked"})}if(s)return await (0,u.$B)(s),i.NextResponse.json({success:!0,message:`All tokens revoked for user ${s}`});if(o)return await (0,u.PX)(o),i.NextResponse.json({success:!0,message:"Token revoked"});return i.NextResponse.json({error:"invalid_request",error_description:"Missing token, user_id, or all parameter"},{status:400})}catch(e){return console.error("[Revoke] Error:",e),i.NextResponse.json({error:"server_error",error_description:"Internal server error"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/revoke/route",pathname:"/api/auth/revoke",filename:"route",bundlePath:"app/api/auth/revoke/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\auth\\revoke\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:v}=_,m="/api/auth/revoke/route";function k(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:p})}},8675:(e,r,t)=>{t.d(r,{$B:()=>_,Gc:()=>u,PX:()=>l,S5:()=>p,Sv:()=>i,gJ:()=>c,rG:()=>h,yh:()=>d});var o=t(4770),s=t.n(o),a=t(1570);let n="true"===process.env.REFRESH_TOKEN_ENABLED;function i(){return s().randomBytes(32).toString("base64url")}async function u(e,r,t,o,s="alexa",n,i){let u=(0,a.createServerClient)(),c=new Date(Date.now()+6e5),{data:d,error:l}=await u.from("users").select("id").eq("id",r).single();if(l||!d)throw console.error("[OAuth] User does not exist when storing auth code:",{user_id:r,error:l,user_found:!!d}),Error(`User ${r} does not exist in database`);let{error:_}=await u.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:s,code_challenge:n,code_challenge_method:i,expires_at:c.toISOString()});if(_)throw console.error("[OAuth] Error storing auth code:",{error_code:_.code,error_message:_.message,error_details:_.details,error_hint:_.hint,user_id:r,user_exists:!!d}),Error(`Failed to store authorization code: ${_.message}`)}async function c(e,r,t,o){let n=(0,a.createServerClient)();try{let{data:a,error:i}=await n.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();if(i||!a)return console.warn("[OAuth] Invalid authorization code:",{code_preview:e?e.substring(0,10)+"...":"missing",client_id:r,redirect_uri:t,error:i,error_code:i?.code,error_message:i?.message}),null;if(new Date(a.expires_at)<new Date)return console.warn("[OAuth] Authorization code expired:",{expires_at:a.expires_at,now:new Date().toISOString()}),null;if(a.used)return console.warn("[OAuth] Authorization code already used:",{code_preview:e.substring(0,10)+"...",used_at:a.used_at}),null;if(a.code_challenge&&o&&s().createHash("sha256").update(o).digest("base64url")!==a.code_challenge)return console.warn("[OAuth] PKCE code verifier mismatch"),null;let{error:u}=await n.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e);return u&&console.error("[OAuth] Failed to mark authorization code as used:",{error:u,error_code:u.code,error_message:u.message}),{userId:a.user_id,scope:a.scope}}catch(e){return console.error("[OAuth] Error validating authorization code:",{error:e,error_message:e?.message,error_stack:e?.stack}),null}}async function d(e,r,t,o,i){let u;let c=(0,a.createServerClient)(),{data:d,error:l}=await c.from("users").select("email").eq("id",e).single();if(l||!d)throw Error("User not found");let _=s().randomBytes(32).toString("base64url"),h=parseInt(process.env.ALEXA_TOKEN_EXPIRES_IN||"86400",10),p=new Date(Date.now()+1e3*h),{error:v}=await c.from("oauth_access_tokens").insert({token:_,user_id:e,client_id:r,scope:t,expires_at:p.toISOString(),revoked:!1});if(v)throw console.error("[OAuth] Error storing access token:",v),Error("Failed to store access token");if(console.log("[OAuth] Issued opaque access token for user:",e,"expires:",p.toISOString()),n){u=s().randomBytes(32).toString("base64url");let{error:t}=await c.from("oauth_refresh_tokens").insert({token:u,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),u=void 0)}return{access_token:_,expires_in:h,refresh_token:u}}async function l(e){let r=(0,a.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function _(e){let r=(0,a.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");n&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function h(e){let r=(0,a.createServerClient)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function p(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>n});var o=t(2851);let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!a)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(s.includes("supabase.com/dashboard")||s.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${s}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function n(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e,{db:{schema:"public"}})}(0,o.createClient)(s,a,{db:{schema:"public"}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851],()=>t(7880));module.exports=o})();