"use strict";(()=>{var e={};e.id=166,e.ids=[166],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},5995:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>k,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{POST:()=>_,dynamic:()=>d});var n=t(3277),s=t(5265),a=t(5356),i=t(7076),c=t(2740),u=t(8675),l=t(1570);let d="force-dynamic";async function _(e){try{let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return i.NextResponse.json({error:"unauthorized",error_description:"Missing or invalid Authorization header"},{status:401});let t=r.replace("Bearer ","").trim();if(!t)return i.NextResponse.json({error:"unauthorized",error_description:"Token is required"},{status:401});let o=(0,l.createServerClient)();if((0,c.kM)(t)){console.log("[Introspect] Processing legacy base64 token");let e=(0,c.lV)(t);if(!e||!e.amazon_account_id)return i.NextResponse.json({error:"invalid_token",error_description:"Invalid legacy token format"},{status:401});let{data:r,error:n}=await o.from("users").select("*").eq("amazon_account_id",e.amazon_account_id).single();if(n||!r)return i.NextResponse.json({error:"invalid_token",error_description:"User not found for legacy token"},{status:401});let s=!1;if(r.license_key){let{data:e}=await o.from("licenses").select("status").eq("license_key",r.license_key).single();s=e?.status==="active"}return i.NextResponse.json({active:!0,user_id:r.id,email:r.email,license_active:s,notion_db_id:r.tasks_db_id,amazon_account_id:r.amazon_account_id,token_type:"legacy"})}let{data:n,error:s}=await o.from("oauth_access_tokens").select("*").eq("token",t).single();if(s||!n){console.log("[Introspect] Token not found in DB, trying as JWT...");let e=(0,c.ez)(t);if(!e)return i.NextResponse.json({error:"invalid_token",error_description:"Token verification failed"},{status:401});if(await (0,u.rG)(t))return i.NextResponse.json({error:"invalid_token",error_description:"Token has been revoked"},{status:401});let{data:r,error:n}=await o.from("users").select("*").eq("id",e.sub).single();if(n||!r)return i.NextResponse.json({error:"invalid_token",error_description:"User not found"},{status:401});let s=!1;if(r.license_key){let{data:e}=await o.from("licenses").select("status").eq("license_key",r.license_key).maybeSingle();s=e?.status==="active"}return i.NextResponse.json({active:!0,user_id:r.id,email:e.email,license_active:s,notion_db_id:e.notion_db_id||r.tasks_db_id,amazon_account_id:e.amazon_account_id||r.amazon_account_id,scope:e.scope,exp:e.exp,iat:e.iat,token_type:"Bearer"})}if(n.revoked)return i.NextResponse.json({error:"invalid_token",error_description:"Token has been revoked"},{status:401});if(new Date(n.expires_at)<new Date)return i.NextResponse.json({error:"invalid_token",error_description:"Token has expired"},{status:401});let{data:a,error:d}=await o.from("users").select("*").eq("id",n.user_id).single();if(d||!a)return i.NextResponse.json({error:"invalid_token",error_description:"User not found"},{status:401});let _=!1;if(a.license_key){let{data:e}=await o.from("licenses").select("status").eq("stripe_payment_intent_id",a.license_key).maybeSingle();_=e?.status==="active"}return i.NextResponse.json({active:!0,user_id:a.id,email:a.email,license_active:_,notion_db_id:a.tasks_db_id,amazon_account_id:a.amazon_account_id,scope:n.scope,exp:Math.floor(new Date(n.expires_at).getTime()/1e3),iat:Math.floor(new Date(n.issued_at).getTime()/1e3),token_type:"Bearer"})}catch(e){return console.error("[Introspect] Error:",e),i.NextResponse.json({error:"server_error",error_description:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/introspect/route",pathname:"/api/auth/introspect",filename:"route",bundlePath:"app/api/auth/introspect/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\auth\\introspect\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:f}=p,k="/api/auth/introspect/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},2740:(e,r,t)=>{t.d(r,{F4:()=>h,SK:()=>p,WJ:()=>_,ez:()=>u,kM:()=>l,lV:()=>d});var o=t(8415),n=t.n(o);let s=process.env.JWT_SECRET||"",a=(parseInt(process.env.JWT_EXPIRES_IN||"3600",10),parseInt(process.env.WEBSITE_JWT_EXPIRES_IN||"3600",10)),i=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function c(){if(!s)throw Error("JWT_SECRET environment variable is required");return s}function u(e){try{return n().verify(e,c(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function l(e){try{let r=Buffer.from(e,"base64").toString("utf-8"),t=JSON.parse(r);return"object"==typeof t&&(t.amazon_account_id||t.email||t.timestamp)&&!t.iss}catch{return!1}}function d(e){try{let r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch{return null}}function _(e){let r=Math.floor(Date.now()/1e3),t={iss:i,sub:e.userId,email:e.email,iat:r,exp:r+a,type:"website_session"};return n().sign(t,c(),{algorithm:"HS256"})}function p(e){try{let r=n().verify(e,c(),{algorithms:["HS256"]});if("website_session"!==r.type)return console.warn("[JWT] Token is not a website session token"),null;return r}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Website token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid website token:",e.message):console.error("[JWT] Website token verification error:",e),null}}async function h(e,r){let o=await Promise.resolve().then(t.t.bind(t,4770,23)),{createServerClient:n}=await Promise.resolve().then(t.bind(t,1570)),s=_({userId:e,email:r}),i=o.randomBytes(32).toString("base64url"),c=new Date(Date.now()+6048e5),u=n(),{error:l}=await u.from("website_refresh_tokens").insert({token:i,user_id:e,expires_at:c.toISOString(),revoked:!1});if(l)throw console.error("[JWT] Error storing refresh token:",l),Error("Failed to store refresh token");return{accessToken:s,refreshToken:i,expiresIn:a}}},8675:(e,r,t)=>{t.d(r,{$B:()=>_,Gc:()=>c,PX:()=>d,S5:()=>h,Sv:()=>i,gJ:()=>u,rG:()=>p,yh:()=>l});var o=t(4770),n=t.n(o),s=t(1570);let a="true"===process.env.REFRESH_TOKEN_ENABLED;function i(){return n().randomBytes(32).toString("base64url")}async function c(e,r,t,o,n="alexa",a,i){let c=(0,s.createServerClient)(),u=new Date(Date.now()+6e5),{data:l,error:d}=await c.from("users").select("id").eq("id",r).single();if(d||!l)throw console.error("[OAuth] User does not exist when storing auth code:",{user_id:r,error:d,user_found:!!l}),Error(`User ${r} does not exist in database`);let{error:_}=await c.from("oauth_authorization_codes").insert({code:e,user_id:r,client_id:t,redirect_uri:o,scope:n,code_challenge:a,code_challenge_method:i,expires_at:u.toISOString()});if(_)throw console.error("[OAuth] Error storing auth code:",{error_code:_.code,error_message:_.message,error_details:_.details,error_hint:_.hint,user_id:r,user_exists:!!l}),Error(`Failed to store authorization code: ${_.message}`)}async function u(e,r,t,o){let a=(0,s.createServerClient)();try{let{data:s,error:i}=await a.from("oauth_authorization_codes").select("*").eq("code",e).eq("client_id",r).eq("redirect_uri",t).single();if(i||!s)return console.warn("[OAuth] Invalid authorization code:",{code_preview:e?e.substring(0,10)+"...":"missing",client_id:r,redirect_uri:t,error:i,error_code:i?.code,error_message:i?.message}),null;if(new Date(s.expires_at)<new Date)return console.warn("[OAuth] Authorization code expired:",{expires_at:s.expires_at,now:new Date().toISOString()}),null;if(s.used)return console.warn("[OAuth] Authorization code already used:",{code_preview:e.substring(0,10)+"...",used_at:s.used_at}),null;if(s.code_challenge&&o&&n().createHash("sha256").update(o).digest("base64url")!==s.code_challenge)return console.warn("[OAuth] PKCE code verifier mismatch"),null;let{error:c}=await a.from("oauth_authorization_codes").update({used:!0,used_at:new Date().toISOString()}).eq("code",e);return c&&console.error("[OAuth] Failed to mark authorization code as used:",{error:c,error_code:c.code,error_message:c.message}),{userId:s.user_id,scope:s.scope}}catch(e){return console.error("[OAuth] Error validating authorization code:",{error:e,error_message:e?.message,error_stack:e?.stack}),null}}async function l(e,r,t,o,i){let c;let u=(0,s.createServerClient)(),{data:l,error:d}=await u.from("users").select("email").eq("id",e).single();if(d||!l)throw Error("User not found");let _=n().randomBytes(32).toString("base64url"),p=parseInt(process.env.ALEXA_TOKEN_EXPIRES_IN||"86400",10),h=new Date(Date.now()+1e3*p),{error:m}=await u.from("oauth_access_tokens").insert({token:_,user_id:e,client_id:r,scope:t,expires_at:h.toISOString(),revoked:!1});if(m)throw console.error("[OAuth] Error storing access token:",m),Error("Failed to store access token");if(console.log("[OAuth] Issued opaque access token for user:",e,"expires:",h.toISOString()),a){c=n().randomBytes(32).toString("base64url");let{error:t}=await u.from("oauth_refresh_tokens").insert({token:c,user_id:e,client_id:r,revoked:!1});t&&(console.warn("[OAuth] Failed to store refresh token, continuing without it"),c=void 0)}return{access_token:_,expires_in:p,refresh_token:c}}async function d(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("token",e);if(t)throw console.error("[OAuth] Error revoking token:",t),Error("Failed to revoke token")}async function _(e){let r=(0,s.createServerClient)(),{error:t}=await r.from("oauth_access_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1);if(t)throw console.error("[OAuth] Error revoking user tokens:",t),Error("Failed to revoke user tokens");a&&await r.from("oauth_refresh_tokens").update({revoked:!0,revoked_at:new Date().toISOString()}).eq("user_id",e).eq("revoked",!1)}async function p(e){let r=(0,s.createServerClient)(),{data:t,error:o}=await r.from("oauth_access_tokens").select("revoked").eq("token",e).single();return!!o||!t||!0===t.revoked}function h(e){return(process.env.ALEXA_REDIRECT_URIS||"").split(",").map(e=>e.trim()).some(r=>e.startsWith(r))}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>a});var o=t(2851);let n="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!n||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(n.includes("supabase.com/dashboard")||n.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${n}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function a(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,o.createClient)(r,e,{db:{schema:"public"}})}(0,o.createClient)(n,s,{db:{schema:"public"}})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[942,786,851,415],()=>t(5995));module.exports=o})();