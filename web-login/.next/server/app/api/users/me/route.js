"use strict";(()=>{var e={};e.id=847,e.ids=[847],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5899:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>g,patchFetch:()=>I,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var r={};o.r(r),o.d(r,{GET:()=>_,dynamic:()=>d});var s=o(3277),n=o(5265),a=o(5356),i=o(7076),l=o(1570),u=o(2851);let d="force-dynamic";async function _(e){try{let t=e.headers.get("authorization"),o=t?.replace("Bearer ","")||e.cookies.get("sb-access-token")?.value||e.cookies.get("sb-"+("https://mwvurelnhrcbtpjtsiyb.supabase.co".split("//")[1]?.split(".")[0]||"default")+"-auth-token")?.value;if(!o)return console.log("No token found in request"),i.NextResponse.json({error:"Unauthorized - No token provided"},{status:401});let r=(0,u.createClient)("https://mwvurelnhrcbtpjtsiyb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII"),{data:{user:s},error:n}=await r.auth.getUser(o);if(n||!s)return i.NextResponse.json({error:"Invalid token"},{status:401});let a=(0,l.l)(),{data:d,error:_}=await a.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, focus_logs_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("auth_user_id",s.id).single();if(console.log("[API /users/me] User lookup result:",{hasUser:!!d,hasError:!!_,errorCode:_?.code,errorMessage:_?.message,authUserId:s.id,timestamp:new Date().toISOString()}),_||!d){console.log("[API /users/me] User not found by auth_user_id, trying email lookup...");let{data:e,error:t}=await a.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, focus_logs_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("email",s.email||"").single();if(e&&!t&&(console.log("[API /users/me] Found user by email, updating auth_user_id..."),d=e,_=null,d&&!d.auth_user_id)){let{error:e}=await a.from("users").update({auth_user_id:s.id}).eq("id",d.id);e?console.error("[API /users/me] Failed to update auth_user_id:",e):(d.auth_user_id=s.id,console.log("[API /users/me] Updated auth_user_id successfully"))}}if(d){console.log("[API /users/me] Raw user data from database:",{id:d.id,email:d.email,auth_user_id:d.auth_user_id,has_notion_token_field:"notion_token"in d,notion_token_value:d.notion_token?"EXISTS":"NULL",notion_token_length:d.notion_token?.length||0,notion_token_preview:d.notion_token?d.notion_token.substring(0,10)+"...":"null",all_keys:Object.keys(d)});let{data:e,error:t}=await a.from("users").select("id, notion_token").eq("id",d.id).single();console.log("[API /users/me] Direct notion_token query:",{hasData:!!e,hasError:!!t,has_notion_token:!!e?.notion_token,token_length:e?.notion_token?.length||0})}if(_&&console.log("[API /users/me] Full error object:",JSON.stringify(_,null,2)),_||!d){console.error("[API /users/me] User not found in database, attempting to create:",{auth_user_id:s.id,email:s.email,error:_?{code:_.code,message:_.message,details:_.details}:null}),console.log("[API /users/me] Attempting to create user:",{auth_user_id:s.id,email:s.email,provider:s.app_metadata?.provider||"email",hasServiceKey:!!process.env.SUPABASE_SERVICE_KEY});let{data:e,error:t}=await a.from("users").insert({auth_user_id:s.id,email:s.email||"",provider:s.app_metadata?.provider||"email",email_verified:!!s.email_confirmed_at||s.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(t){if(console.error("[API /users/me] Create error details:",{code:t.code,message:t.message,details:t.details,hint:t.hint}),"23505"!==t.code)return console.error("[API /users/me] Failed to create user with non-duplicate error"),i.NextResponse.json({error:"User not found",details:t.message},{status:404});{console.log("[API /users/me] Duplicate key error, fetching existing user...");let{data:e,error:t}=await a.from("users").select("*").eq("auth_user_id",s.id).single();if(!e||t)return console.error("[API /users/me] Failed to fetch user after duplicate error:",t),i.NextResponse.json({error:"User not found"},{status:404});d=e,console.log("[API /users/me] User found after duplicate error:",e.id)}}else{if(!e)return console.error("[API /users/me] Insert returned no user and no error"),i.NextResponse.json({error:"User not found"},{status:404});d=e,console.log("[API /users/me] ✅ User created successfully as fallback:",{id:e.id,email:e.email,auth_user_id:e.auth_user_id})}}else console.log("[API /users/me] User already exists in database:",{id:d.id,email:d.email,notion_setup_complete:d.notion_setup_complete,has_notion_token:!!d.notion_token,notion_token_length:d.notion_token?.length||0,notion_token_preview:d.notion_token?d.notion_token.substring(0,20)+"...":"null"});if(!d)return console.error("[API /users/me] User is null after all attempts"),i.NextResponse.json({error:"User not found"},{status:404});let{data:c}=await a.from("oauth_access_tokens").select("id").eq("user_id",d.id).eq("revoked",!1).gt("expires_at",new Date().toISOString()).limit(1).single(),p=!!c,{password_hash:m,...h}=d;return console.log("[API /users/me] Returning user data:",{id:h.id,email:h.email,notion_setup_complete:h.notion_setup_complete,has_notion_token:!!h.notion_token,notion_token_length:h.notion_token?.length||0,has_jwt_token:p}),i.NextResponse.json({...h,notion_token:h.notion_token||null,has_jwt_token:p})}catch(e){return console.error("Error getting user:",e),i.NextResponse.json({error:e.message||"Internal server error"},{status:500})}}let c=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/users/me/route",pathname:"/api/users/me",filename:"route",bundlePath:"app/api/users/me/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\users\\me\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h}=c,g="/api/users/me/route";function I(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},1570:(e,t,o)=>{o.d(t,{l:()=>a});var r=o(2851);let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!n)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(s.includes("supabase.com/dashboard")||s.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${s}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function a(){let e=process.env.SUPABASE_SERVICE_KEY||"",t="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!t)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,r.createClient)(t,e)}(0,r.createClient)(s,n)}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[942,786,851],()=>o(5899));module.exports=r})();