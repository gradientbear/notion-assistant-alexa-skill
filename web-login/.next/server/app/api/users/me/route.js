"use strict";(()=>{var e={};e.id=847,e.ids=[847],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5899:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>g,patchFetch:()=>k,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var s={};o.r(s),o.d(s,{GET:()=>l,dynamic:()=>u});var r=o(3277),i=o(5265),n=o(5356),a=o(7076),d=o(1570),_=o(2851);let u="force-dynamic";async function l(e){try{let t=e.headers.get("authorization"),o=t?.replace("Bearer ","")||e.cookies.get("sb-access-token")?.value||e.cookies.get("sb-"+("https://mwvurelnhrcbtpjtsiyb.supabase.co".split("//")[1]?.split(".")[0]||"default")+"-auth-token")?.value;if(!o)return console.log("No token found in request"),a.NextResponse.json({error:"Unauthorized - No token provided"},{status:401});let s=(0,_.createClient)("https://mwvurelnhrcbtpjtsiyb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII"),{data:{user:r},error:i}=await s.auth.getUser(o);if(i||!r)return a.NextResponse.json({error:"Invalid token"},{status:401});let n=(0,d.l)(),{data:u,error:l}=await n.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, shopping_db_id, workouts_db_id, meals_db_id, notes_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("auth_user_id",r.id),p=null;if(u&&u.length>0){let e=u.find(e=>!!e.notion_token);if(e?(p=e,console.log("[API /users/me] Selected user with Notion token:",{user_id:p.id,has_notion_token:!0,notion_setup_complete:p.notion_setup_complete})):(p=u.sort((e,t)=>new Date(t.updated_at||t.created_at).getTime()-new Date(e.updated_at||e.created_at).getTime())[0],console.log("[API /users/me] Selected most recently updated user:",{user_id:p.id,updated_at:p.updated_at,has_notion_token:!!p.notion_token})),u.length>1){console.warn("[API /users/me] ⚠️ Multiple users found with same auth_user_id!",{total_users:u.length,selected_user_id:p.id,all_user_ids:u.map(e=>({id:e.id,has_notion_token:!!e.notion_token,notion_setup_complete:e.notion_setup_complete,updated_at:e.updated_at})),auth_user_id:r.id});let e=u.find(e=>e.id!==p.id&&!!e.notion_token&&e.notion_setup_complete);e&&!p.notion_token&&console.warn("[API /users/me] ⚠️ Found Notion data in different user record!",{selected_user_id:p.id,user_with_notion_id:e.id,message:"Notion data exists in a different user record. User should reconnect Notion to fix this."})}l=null}else l&&console.error("[API /users/me] Error querying users by auth_user_id:",l);if(console.log("[API /users/me] User lookup result:",{hasUser:!!p,hasError:!!l,errorCode:l?.code,errorMessage:l?.message,authUserId:r.id,totalUsersFound:u?.length||0,selectedUserId:p?.id,timestamp:new Date().toISOString()}),l||!p){console.log("[API /users/me] User not found by auth_user_id, trying email lookup...");let{data:e,error:t}=await n.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, shopping_db_id, workouts_db_id, meals_db_id, notes_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("email",r.email||"");if(e&&!t&&e.length>0){let t=e.find(e=>e.auth_user_id===r.id);if(console.log("[API /users/me] Email lookup results:",{total_users:e.length,users_with_matching_auth_id:e.filter(e=>e.auth_user_id===r.id).length,users_with_notion_token:e.filter(e=>!!e.notion_token).length,auth_user_id_to_match:r.id}),t||(t=e.find(e=>!!e.notion_token)),t||(t=e.sort((e,t)=>new Date(t.updated_at||t.created_at).getTime()-new Date(e.updated_at||e.created_at).getTime())[0]),t&&(console.log("[API /users/me] Found user by email:",{id:t.id,auth_user_id:t.auth_user_id,has_notion_token:!!t.notion_token,matches_auth_user_id:t.auth_user_id===r.id}),p=t,l=null,p&&p.auth_user_id!==r.id)){let{error:e}=await n.from("users").update({auth_user_id:r.id}).eq("id",p.id);e?console.error("[API /users/me] Failed to update auth_user_id:",e):(p.auth_user_id=r.id,console.log("[API /users/me] Updated auth_user_id successfully"))}}}if(p){console.log("[API /users/me] Raw user data from database:",{id:p.id,email:p.email,auth_user_id:p.auth_user_id,has_notion_token_field:"notion_token"in p,notion_token_value:p.notion_token?"EXISTS":"NULL",notion_token_length:p.notion_token?.length||0,notion_token_preview:p.notion_token?p.notion_token.substring(0,10)+"...":"null",notion_setup_complete:p.notion_setup_complete,all_keys:Object.keys(p)});let{data:e,error:t}=await n.from("users").select("id, notion_token").eq("id",p.id).single();console.log("[API /users/me] Direct notion_token query:",{hasData:!!e,hasError:!!t,has_notion_token:!!e?.notion_token,token_length:e?.notion_token?.length||0})}if(l&&(console.log("[API /users/me] Full error object:",JSON.stringify(l,null,2)),"42703"===l.code&&l.message?.includes("focus_logs_db_id"))){console.log("[API /users/me] Database schema error detected, trying simpler query...");let{data:e,error:t}=await n.from("users").select("*").eq("auth_user_id",r.id).single();e&&!t&&(p=e,l=null,console.log("[API /users/me] Found user with simple query:",e.id))}if(l||!p){console.error("[API /users/me] User not found in database, attempting to create:",{auth_user_id:r.id,email:r.email,error:l?{code:l.code,message:l.message,details:l.details}:null}),console.log("[API /users/me] Attempting to create user:",{auth_user_id:r.id,email:r.email,provider:r.app_metadata?.provider||"email",hasServiceKey:!!process.env.SUPABASE_SERVICE_KEY});let{data:e,error:t}=await n.from("users").insert({auth_user_id:r.id,email:r.email||"",provider:r.app_metadata?.provider||"email",email_verified:!!r.email_confirmed_at||r.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(t){if(console.error("[API /users/me] Create error details:",{code:t.code,message:t.message,details:t.details,hint:t.hint}),"23505"!==t.code)return console.error("[API /users/me] Failed to create user with non-duplicate error"),a.NextResponse.json({error:"User not found",details:t.message},{status:404});{console.log("[API /users/me] Duplicate key error, fetching existing user...");let{data:e,error:t}=await n.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, shopping_db_id, workouts_db_id, meals_db_id, notes_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("auth_user_id",r.id).single();if(e&&!t)p=e,console.log("[API /users/me] User found after duplicate error:",{id:e.id,auth_user_id:e.auth_user_id,has_notion_token:!!e.notion_token,notion_setup_complete:e.notion_setup_complete});else{if(console.error("[API /users/me] Failed to fetch user after duplicate error:",t),!r.email)return a.NextResponse.json({error:"User not found"},{status:404});{console.log("[API /users/me] Trying email lookup as last resort...");let{data:e}=await n.from("users").select("id, auth_user_id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, shopping_db_id, workouts_db_id, meals_db_id, notes_db_id, energy_logs_db_id, onboarding_complete, created_at, updated_at").eq("email",r.email).maybeSingle();if(!e)return a.NextResponse.json({error:"User not found"},{status:404});p=e,e.auth_user_id||await n.from("users").update({auth_user_id:r.id}).eq("id",e.id),console.log("[API /users/me] Found user by email:",e.id)}}}}else{if(!e)return console.error("[API /users/me] Insert returned no user and no error"),a.NextResponse.json({error:"User not found"},{status:404});p=e,console.log("[API /users/me] ✅ User created successfully as fallback:",{id:e.id,email:e.email,auth_user_id:e.auth_user_id})}}else console.log("[API /users/me] User already exists in database:",{id:p.id,email:p.email,notion_setup_complete:p.notion_setup_complete,has_notion_token:!!p.notion_token,notion_token_length:p.notion_token?.length||0,notion_token_preview:p.notion_token?p.notion_token.substring(0,20)+"...":"null"});if(!p)return console.error("[API /users/me] User is null after all attempts"),a.NextResponse.json({error:"User not found"},{status:404});let{data:c,error:m}=await n.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",p.id).eq("revoked",!1).gt("expires_at",new Date().toISOString()).limit(1).maybeSingle();if(m)console.error("[API /users/me] Error checking for JWT token:",m);else if(c)console.log("[API /users/me] Found active JWT token:",{token_preview:c.token?c.token.substring(0,20)+"...":"null",expires_at:c.expires_at});else{let{data:e}=await n.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",p.id).limit(5);console.log("[API /users/me] No active JWT token found. All tokens for user:",{user_id:p.id,token_count:e?.length||0,tokens:e?.map(e=>({token_preview:e.token?e.token.substring(0,20)+"...":"null",expires_at:e.expires_at,revoked:e.revoked,is_expired:new Date(e.expires_at)<=new Date}))})}let h=!!c,{password_hash:g,...k}=p;return console.log("[API /users/me] Returning user data:",{id:k.id,email:k.email,notion_setup_complete:k.notion_setup_complete,has_notion_token:!!k.notion_token,notion_token_length:k.notion_token?.length||0,has_jwt_token:h}),a.NextResponse.json({...k,notion_token:k.notion_token||null,has_jwt_token:h})}catch(e){return console.error("Error getting user:",e),a.NextResponse.json({error:e.message||"Internal server error"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/users/me/route",pathname:"/api/users/me",filename:"route",bundlePath:"app/api/users/me/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\users\\me\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:h}=p,g="/api/users/me/route";function k(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},1570:(e,t,o)=>{o.d(t,{l:()=>n});var s=o(2851);let r="https://mwvurelnhrcbtpjtsiyb.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!r||!i)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(r.includes("supabase.com/dashboard")||r.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${r}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function n(){let e=process.env.SUPABASE_SERVICE_KEY||"",t="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!t)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,s.createClient)(t,e)}(0,s.createClient)(r,i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[942,786,851],()=>o(5899));module.exports=s})();