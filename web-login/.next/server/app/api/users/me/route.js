"use strict";(()=>{var e={};e.id=847,e.ids=[847],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},5899:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>I,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>k});var r={};o.r(r),o.d(r,{GET:()=>c,dynamic:()=>d});var s=o(3277),n=o(5265),a=o(5356),i=o(7076),u=o(1570),l=o(2851),p=o(2740);let d="force-dynamic";async function c(e){try{let t=e.headers.get("authorization"),o=t?.replace("Bearer ","")||e.cookies.get("sb-access-token")?.value||e.cookies.get("sb-"+("https://mwvurelnhrcbtpjtsiyb.supabase.co".split("//")[1]?.split(".")[0]||"default")+"-auth-token")?.value;if(!o)return console.log("No token found in request"),i.NextResponse.json({error:"Unauthorized - No token provided"},{status:401});let r=(0,p.SK)(o),s=null;if(r)s=r.sub,r.email,console.log("[API /users/me] Authenticated via website JWT:",s);else{let e=(0,l.createClient)("https://mwvurelnhrcbtpjtsiyb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII"),{data:{user:t},error:r}=await e.auth.getUser(o);if(r||!t)return i.NextResponse.json({error:"Invalid token"},{status:401});s=t.id,t.email,t.app_metadata?.provider,console.log("[API /users/me] Authenticated via Supabase session token:",s)}if(!s)return i.NextResponse.json({error:"Invalid token"},{status:401});let n=(0,u.createServerClient)(),a=null,d=null;for(let e=0;e<3;e++){let t=await n.from("users").select("id, email, password_hash, email_verified, provider, provider_id, amazon_account_id, license_key, notion_token, notion_setup_complete, privacy_page_id, tasks_db_id, onboarding_complete, created_at, updated_at").eq("id",s).single();if(a=t.data,d=t.error,a&&!d){let t=new Date(a.updated_at),o=new Date().getTime()-t.getTime();if(o<1e4||a.notion_token||2===e){console.log(`[API /users/me] ✅ Got user data on attempt ${e+1}`,{has_notion_token:!!a.notion_token,data_age_ms:o,is_fresh:o<1e4,is_last_attempt:2===e});break}console.log(`[API /users/me] ⏳ Data appears stale (age: ${o}ms), retrying...`)}if(d&&"PGRST116"!==d.code)break;e<2&&(console.log(`[API /users/me] ⏳ Retry ${e+1}/3 - waiting 500ms for replication...`),await new Promise(e=>setTimeout(e,500)))}if(console.log("[API /users/me] User lookup result:",{hasUser:!!a,hasError:!!d,errorCode:d?.code,errorMessage:d?.message,userId:s,timestamp:new Date().toISOString()}),a)console.log("[API /users/me] \uD83D\uDD0D User found in database:",{id:a.id,email:a.email,has_notion_token_field:"notion_token"in a,notion_token_value:a.notion_token?"EXISTS":"NULL",notion_token_length:a.notion_token?.length||0,notion_token_preview:a.notion_token?a.notion_token.substring(0,10)+"...":"null",notion_setup_complete:a.notion_setup_complete,privacy_page_id:a.privacy_page_id,tasks_db_id:a.tasks_db_id,updated_at:a.updated_at}),console.log("[API /users/me] \uD83D\uDD0D Raw user object keys:",Object.keys(a)),console.log("[API /users/me] \uD83D\uDD0D Raw user notion fields:",{notion_token:a.notion_token,notion_setup_complete:a.notion_setup_complete,privacy_page_id:a.privacy_page_id,tasks_db_id:a.tasks_db_id});else if(d)return console.error("[API /users/me] User not found:",{userId:s,errorCode:d.code,errorMessage:d.message}),i.NextResponse.json({error:"User not found"},{status:404});if(!a)return console.error("[API /users/me] User is null after all attempts"),i.NextResponse.json({error:"User not found"},{status:404});let{data:c,error:_}=await n.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",a.id).eq("revoked",!1).gt("expires_at",new Date().toISOString()).limit(1).maybeSingle();if(_)console.error("[API /users/me] Error checking for opaque token:",_);else if(c)console.log("[API /users/me] Found active opaque token:",{token_preview:c.token?c.token.substring(0,20)+"...":"null",expires_at:c.expires_at});else{let{data:e}=await n.from("oauth_access_tokens").select("token, expires_at, revoked").eq("user_id",a.id).limit(5);console.log("[API /users/me] No active opaque token found. All tokens for user:",{user_id:a.id,token_count:e?.length||0,tokens:e?.map(e=>({token_preview:e.token?e.token.substring(0,20)+"...":"null",expires_at:e.expires_at,revoked:e.revoked,is_expired:new Date(e.expires_at)<=new Date}))})}let m=!!c,{password_hash:k,...h}=a,I={...h,notion_token:h.notion_token||null,has_jwt_token:m};return console.log("[API /users/me] \uD83D\uDD0D Returning user data:",{id:h.id,email:h.email,notion_setup_complete:h.notion_setup_complete,has_notion_token:!!h.notion_token,notion_token_length:h.notion_token?.length||0,has_jwt_token:m,privacy_page_id:h.privacy_page_id,tasks_db_id:h.tasks_db_id,updated_at:h.updated_at}),console.log("[API /users/me] \uD83D\uDD0D Response payload notion fields:",{notion_token:I.notion_token?"EXISTS ("+I.notion_token.length+" chars)":"NULL",notion_setup_complete:I.notion_setup_complete,privacy_page_id:I.privacy_page_id,tasks_db_id:I.tasks_db_id}),i.NextResponse.json(I,{headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}catch(e){return console.error("Error getting user:",e),i.NextResponse.json({error:e.message||"Internal server error"},{status:500})}}let _=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/users/me/route",pathname:"/api/users/me",filename:"route",bundlePath:"app/api/users/me/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\api\\users\\me\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:k,serverHooks:h}=_,I="/api/users/me/route";function g(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:k})}},2740:(e,t,o)=>{o.d(t,{F4:()=>m,SK:()=>_,WJ:()=>c,ez:()=>l,kM:()=>p,lV:()=>d});var r=o(8415),s=o.n(r);let n=process.env.JWT_SECRET||"",a=(parseInt(process.env.JWT_EXPIRES_IN||"3600",10),parseInt(process.env.WEBSITE_JWT_EXPIRES_IN||"3600",10)),i=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function u(){if(!n)throw Error("JWT_SECRET environment variable is required");return n}function l(e){try{return s().verify(e,u(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function p(e){try{let t=Buffer.from(e,"base64").toString("utf-8"),o=JSON.parse(t);return"object"==typeof o&&(o.amazon_account_id||o.email||o.timestamp)&&!o.iss}catch{return!1}}function d(e){try{let t=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(t)}catch{return null}}function c(e){let t=Math.floor(Date.now()/1e3),o={iss:i,sub:e.userId,email:e.email,iat:t,exp:t+a,type:"website_session"};return s().sign(o,u(),{algorithm:"HS256"})}function _(e){try{let t=s().verify(e,u(),{algorithms:["HS256"]});if("website_session"!==t.type)return console.warn("[JWT] Token is not a website session token"),null;return t}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Website token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid website token:",e.message):console.error("[JWT] Website token verification error:",e),null}}async function m(e,t){let r=await Promise.resolve().then(o.t.bind(o,4770,23)),{createServerClient:s}=await Promise.resolve().then(o.bind(o,1570)),n=c({userId:e,email:t}),i=r.randomBytes(32).toString("base64url"),u=new Date(Date.now()+6048e5),l=s(),{error:p}=await l.from("website_refresh_tokens").insert({token:i,user_id:e,expires_at:u.toISOString(),revoked:!1});if(p)throw console.error("[JWT] Error storing refresh token:",p),Error("Failed to store refresh token");return{accessToken:n,refreshToken:i,expiresIn:a}}},1570:(e,t,o)=>{o.d(t,{createServerClient:()=>a});var r=o(2851);let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!n)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(s.includes("supabase.com/dashboard")||s.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${s}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function a(){let e=process.env.SUPABASE_SERVICE_KEY||"",t="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!t)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,r.createClient)(t,e,{db:{schema:"public"}})}(0,r.createClient)(s,n,{db:{schema:"public"}})}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[942,786,851,415],()=>o(5899));module.exports=r})();