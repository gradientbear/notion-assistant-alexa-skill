"use strict";(()=>{var e={};e.id=936,e.ids=[936],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},5772:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>b,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>h,serverHooks:()=>k,staticGenerationAsyncStorage:()=>m});var a={};t.r(a),t.d(a,{GET:()=>d,dynamic:()=>u});var o=t(3277),s=t(5265),i=t(5356),n=t(7076),l=t(1570),c=t(2740);let u="force-dynamic";async function d(e){let r=new URL(e.url),a=r.searchParams.get("code"),o=r.searchParams.get("error");if(console.log("[Auth Callback] Request received:",{url:r.toString(),hasCode:!!a,codeLength:a?.length||0,error:o,allParams:Object.fromEntries(r.searchParams.entries())}),o)return console.error("[Auth Callback] OAuth error:",o),n.NextResponse.redirect(new URL(`/?error=${encodeURIComponent(o)}`,e.url));let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!i)return console.error("[Auth Callback] Missing Supabase environment variables"),n.NextResponse.redirect(new URL("/?error=Server configuration error",e.url));let{createClient:u}=await Promise.resolve().then(t.bind(t,2851)),d=u(s,i),h=s.split("//")[1]?.split(".")[0]||"default",p=`sb-${h}-auth-token`,m=e.cookies.get("sb-access-token")?.value||e.cookies.get(p)?.value;if(console.log("[Auth Callback] Cookie check:",{hasAccessToken:!!e.cookies.get("sb-access-token")?.value,hasProjectCookie:!!e.cookies.get(p)?.value,cookieName:p,allCookies:Object.keys(Object.fromEntries(e.cookies.getAll().map(e=>[e.name,"***"])))}),a){console.log("[Auth Callback] Exchanging code for session...");let{data:r,error:t}=await d.auth.exchangeCodeForSession(a);if(t)return console.error("[Auth Callback] Error exchanging code for session:",t),n.NextResponse.redirect(new URL("/?error=Authentication failed",e.url));if(!r.user)return console.error("[Auth Callback] No user in session data after code exchange"),n.NextResponse.redirect(new URL("/?error=Authentication failed - no user data",e.url));{console.log("[Auth Callback] User authenticated:",r.user.id,r.user.email);let t=!1;try{let a=(0,l.createServerClient)(),{data:o,error:s}=await a.from("users").select("*").eq("id",r.user.id).maybeSingle();if(s&&"PGRST116"!==s.code&&console.error("[Auth Callback] Error checking existing user:",s),o)console.log("[Auth Callback] User already exists:",o.id),t=!0,r.user.email_confirmed_at&&!o.email_verified&&await a.from("users").update({email_verified:!0}).eq("id",o.id);else{console.log("[Auth Callback] Creating new user in database",{id:r.user.id,email:r.user.email,provider:r.user.app_metadata?.provider||"email"});let{data:e,error:o}=await a.from("users").insert({id:r.user.id,email:r.user.email||"",provider:r.user.app_metadata?.provider||"email",email_verified:!!r.user.email_confirmed_at||r.user.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(o){if(console.error("[Auth Callback] Error creating user:",{code:o.code,message:o.message,details:o.details,hint:o.hint}),"23505"===o.code){console.log("[Auth Callback] Duplicate key error - user might already exist, fetching...");let{data:e,error:o}=await a.from("users").select("*").eq("id",r.user.id).single();e&&!o?(console.log("[Auth Callback] User found after duplicate error:",e.id),t=!0):console.error("[Auth Callback] Failed to fetch user after duplicate error:",o)}else console.error("[Auth Callback] Non-duplicate insert error, will attempt verification anyway")}else e?(console.log("[Auth Callback] User created successfully:",e.id),t=!0):console.error("[Auth Callback] Insert succeeded but no user returned")}if(!t)return console.error("[Auth Callback] Failed to create user in database"),n.NextResponse.redirect(new URL("/?error=User creation failed. Please try again.",e.url));{let t=!1;for(let e=0;e<3;e++){let{data:o,error:s}=await a.from("users").select("id").eq("id",r.user.id).single();if(o&&!s){t=!0,console.log("[Auth Callback] User verified in database:",o.id);break}e<2&&await new Promise(e=>setTimeout(e,200))}if(!t)return console.error("[Auth Callback] User not found in database after creation attempts"),n.NextResponse.redirect(new URL("/?error=User creation failed. Please try again.",e.url))}}catch(r){return console.error("[Auth Callback] Error syncing user:",r),n.NextResponse.redirect(new URL("/?error=Authentication error. Please try again.",e.url))}return n.NextResponse.redirect(new URL("/dashboard",e.url))}}if(m){console.log("[Auth Callback] Found access token in cookies, verifying user...");let{data:{user:r},error:t}=await d.auth.getUser(m);if(t||!r)return console.error("[Auth Callback] Invalid access token:",t),n.NextResponse.redirect(new URL("/?error=Invalid session",e.url));console.log("[Auth Callback] User authenticated via token:",r.id,r.email);let a=!1;try{let t=(0,l.createServerClient)(),{data:o,error:s}=await t.from("users").select("*").eq("id",r.id).maybeSingle();if(s&&"PGRST116"!==s.code&&console.error("[Auth Callback] Error checking existing user:",s),o)a=!0;else{console.log("[Auth Callback] Creating new user in database via token flow");let{data:e,error:o}=await t.from("users").insert({id:r.id,email:r.email||"",provider:r.app_metadata?.provider||"email",email_verified:!!r.email_confirmed_at||r.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(o){if(console.error("[Auth Callback] Error creating user:",o),"23505"===o.code){let{data:e}=await t.from("users").select("*").eq("id",r.id).single();e&&(a=!0)}}else e&&(a=!0)}if(!a)return n.NextResponse.redirect(new URL("/?error=User creation failed",e.url));try{let{data:a}=await t.from("users").select("id, email").eq("id",r.id).single();if(a){let r=await (0,c.F4)(a.id,a.email||""),t=new URL("/dashboard",e.url);t.searchParams.set("access_token",r.accessToken),t.searchParams.set("refresh_token",r.refreshToken);let o=n.NextResponse.redirect(t);return o.cookies.set("refresh_token",r.refreshToken,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),o}}catch(e){console.error("[Auth Callback] Error issuing website tokens:",e)}return n.NextResponse.redirect(new URL("/dashboard",e.url))}catch(r){return console.error("[Auth Callback] Error syncing user:",r),n.NextResponse.redirect(new URL("/?error=Authentication error",e.url))}}console.log("[Auth Callback] No code or token - Supabase OAuth handled client-side, checking for session...");let k=e.cookies.getAll(),b=null;if(console.log("[Auth Callback] All cookies:",k.map(e=>({name:e.name,hasValue:!!e.value,valueLength:e.value?.length||0}))),b=e.cookies.get("sb-access-token")?.value||e.cookies.get(p)?.value||null)console.log("[Auth Callback] Found session token using standard pattern:",{cookieName:p,tokenLength:b.length});else for(let e of k){let r=e.name;if(r.includes("auth-token")||r.startsWith("sb-")&&r.includes("auth")){b=e.value,console.log("[Auth Callback] Found session token in cookie (fallback):",r);break}}if(b||console.log("[Auth Callback] No session token found. All cookie names:",k.map(e=>e.name)),b)try{let{data:{user:r},error:t}=await d.auth.getUser(b);if(r&&!t){console.log("[Auth Callback] Found user in session (client-side OAuth):",r.id,r.email);let t=(0,l.createServerClient)(),{data:a,error:o}=await t.from("users").select("*").eq("id",r.id).maybeSingle();if(o&&"PGRST116"!==o.code&&console.error("[Auth Callback] Error checking existing user:",o),a)console.log("[Auth Callback] User already exists in database:",a.id);else{console.log("[Auth Callback] Creating new user in database (client-side OAuth flow)");let{data:e,error:a}=await t.from("users").insert({id:r.id,email:r.email||"",provider:r.app_metadata?.provider||"email",email_verified:!!r.email_confirmed_at||r.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();a?(console.error("[Auth Callback] Error creating user:",{code:a.code,message:a.message,details:a.details}),"23505"===a.code&&console.log("[Auth Callback] User already exists (duplicate key)")):e&&console.log("[Auth Callback] User created successfully (client-side OAuth):",e.id)}try{let t=await (0,c.F4)(a?.id||r.id,r.email||""),o=new URL("/dashboard",e.url);o.searchParams.set("access_token",t.accessToken),o.searchParams.set("refresh_token",t.refreshToken);let s=n.NextResponse.redirect(o);return s.cookies.set("refresh_token",t.refreshToken,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),s}catch(e){console.error("[Auth Callback] Error issuing website tokens:",e)}return n.NextResponse.redirect(new URL("/dashboard",e.url))}console.log("[Auth Callback] Could not get user from session token:",t?.message)}catch(e){console.error("[Auth Callback] Error checking session for client-side OAuth:",e)}else console.log("[Auth Callback] No session token found in cookies");return console.log("[Auth Callback] Redirecting to dashboard (user creation will happen via /api/users/me fallback if needed)"),n.NextResponse.redirect(new URL("/dashboard",e.url))}let h=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/auth/callback/route",pathname:"/auth/callback",filename:"route",bundlePath:"app/auth/callback/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\auth\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:k}=h,b="/auth/callback/route";function f(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:m})}},2740:(e,r,t)=>{t.d(r,{F4:()=>m,SK:()=>p,WJ:()=>h,ez:()=>c,kM:()=>u,lV:()=>d});var a=t(8415),o=t.n(a);let s=process.env.JWT_SECRET||"",i=(parseInt(process.env.JWT_EXPIRES_IN||"3600",10),parseInt(process.env.WEBSITE_JWT_EXPIRES_IN||"3600",10)),n=process.env.APP_ISS||"https://voice-planner-murex.vercel.app";function l(){if(!s)throw Error("JWT_SECRET environment variable is required");return s}function c(e){try{return o().verify(e,l(),{algorithms:["HS256"]})}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid token:",e.message):console.error("[JWT] Verification error:",e),null}}function u(e){try{let r=Buffer.from(e,"base64").toString("utf-8"),t=JSON.parse(r);return"object"==typeof t&&(t.amazon_account_id||t.email||t.timestamp)&&!t.iss}catch{return!1}}function d(e){try{let r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch{return null}}function h(e){let r=Math.floor(Date.now()/1e3),t={iss:n,sub:e.userId,email:e.email,iat:r,exp:r+i,type:"website_session"};return o().sign(t,l(),{algorithm:"HS256"})}function p(e){try{let r=o().verify(e,l(),{algorithms:["HS256"]});if("website_session"!==r.type)return console.warn("[JWT] Token is not a website session token"),null;return r}catch(e){return"TokenExpiredError"===e.name?console.warn("[JWT] Website token expired:",e.message):"JsonWebTokenError"===e.name?console.warn("[JWT] Invalid website token:",e.message):console.error("[JWT] Website token verification error:",e),null}}async function m(e,r){let a=await Promise.resolve().then(t.t.bind(t,4770,23)),{createServerClient:o}=await Promise.resolve().then(t.bind(t,1570)),s=h({userId:e,email:r}),n=a.randomBytes(32).toString("base64url"),l=new Date(Date.now()+6048e5),c=o(),{error:u}=await c.from("website_refresh_tokens").insert({token:n,user_id:e,expires_at:l.toISOString(),revoked:!1});if(u)throw console.error("[JWT] Error storing refresh token:",u),Error("Failed to store refresh token");return{accessToken:s,refreshToken:n,expiresIn:i}}},1570:(e,r,t)=>{t.d(r,{createServerClient:()=>i});var a=t(2851);let o="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!o||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(o.includes("supabase.com/dashboard")||o.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${o}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function i(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,a.createClient)(r,e,{db:{schema:"public"}})}(0,a.createClient)(o,s,{db:{schema:"public"}})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[942,786,851,415],()=>t(5772));module.exports=a})();