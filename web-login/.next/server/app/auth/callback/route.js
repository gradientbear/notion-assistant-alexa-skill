"use strict";(()=>{var e={};e.id=936,e.ids=[936],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5772:(e,r,a)=>{a.r(r),a.d(r,{originalPathname:()=>b,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var t={};a.r(t),a.d(t,{GET:()=>u,dynamic:()=>c});var o=a(3277),s=a(5265),l=a(5356),i=a(7076),n=a(1570);let c="force-dynamic";async function u(e){let r=new URL(e.url),t=r.searchParams.get("code"),o=r.searchParams.get("error");if(console.log("[Auth Callback] Request received:",{url:r.toString(),hasCode:!!t,codeLength:t?.length||0,error:o,allParams:Object.fromEntries(r.searchParams.entries())}),o)return console.error("[Auth Callback] OAuth error:",o),i.NextResponse.redirect(new URL(`/?error=${encodeURIComponent(o)}`,e.url));let s="https://mwvurelnhrcbtpjtsiyb.supabase.co",l="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!s||!l)return console.error("[Auth Callback] Missing Supabase environment variables"),i.NextResponse.redirect(new URL("/?error=Server configuration error",e.url));let{createClient:c}=await Promise.resolve().then(a.bind(a,2851)),u=c(s,l),d=s.split("//")[1]?.split(".")[0]||"default",h=`sb-${d}-auth-token`,p=e.cookies.get("sb-access-token")?.value||e.cookies.get(h)?.value;if(console.log("[Auth Callback] Cookie check:",{hasAccessToken:!!e.cookies.get("sb-access-token")?.value,hasProjectCookie:!!e.cookies.get(h)?.value,cookieName:h,allCookies:Object.keys(Object.fromEntries(e.cookies.getAll().map(e=>[e.name,"***"])))}),t){console.log("[Auth Callback] Exchanging code for session...");let{data:r,error:a}=await u.auth.exchangeCodeForSession(t);if(a)return console.error("[Auth Callback] Error exchanging code for session:",a),i.NextResponse.redirect(new URL("/?error=Authentication failed",e.url));if(!r.user)return console.error("[Auth Callback] No user in session data after code exchange"),i.NextResponse.redirect(new URL("/?error=Authentication failed - no user data",e.url));{console.log("[Auth Callback] User authenticated:",r.user.id,r.user.email);let a=!1;try{let t=(0,n.l)(),{data:o,error:s}=await t.from("users").select("*").eq("auth_user_id",r.user.id).maybeSingle();if(s&&"PGRST116"!==s.code&&console.error("[Auth Callback] Error checking existing user:",s),o)console.log("[Auth Callback] User already exists:",o.id),a=!0,r.user.email_confirmed_at&&!o.email_verified&&await t.from("users").update({email_verified:!0}).eq("id",o.id);else{console.log("[Auth Callback] Creating new user in database",{auth_user_id:r.user.id,email:r.user.email,provider:r.user.app_metadata?.provider||"email"});let{data:e,error:o}=await t.from("users").insert({auth_user_id:r.user.id,email:r.user.email||"",provider:r.user.app_metadata?.provider||"email",email_verified:!!r.user.email_confirmed_at||r.user.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(o){if(console.error("[Auth Callback] Error creating user:",{code:o.code,message:o.message,details:o.details,hint:o.hint}),"23505"===o.code){console.log("[Auth Callback] Duplicate key error - user might already exist, fetching...");let{data:e,error:o}=await t.from("users").select("*").eq("auth_user_id",r.user.id).single();e&&!o?(console.log("[Auth Callback] User found after duplicate error:",e.id),a=!0):console.error("[Auth Callback] Failed to fetch user after duplicate error:",o)}else console.error("[Auth Callback] Non-duplicate insert error, will attempt verification anyway")}else e?(console.log("[Auth Callback] User created successfully:",e.id),a=!0):console.error("[Auth Callback] Insert succeeded but no user returned")}if(!a)return console.error("[Auth Callback] Failed to create user in database"),i.NextResponse.redirect(new URL("/?error=User creation failed. Please try again.",e.url));{let a=!1;for(let e=0;e<3;e++){let{data:o,error:s}=await t.from("users").select("id").eq("auth_user_id",r.user.id).single();if(o&&!s){a=!0,console.log("[Auth Callback] User verified in database:",o.id);break}e<2&&await new Promise(e=>setTimeout(e,200))}if(!a)return console.error("[Auth Callback] User not found in database after creation attempts"),i.NextResponse.redirect(new URL("/?error=User creation failed. Please try again.",e.url))}}catch(r){return console.error("[Auth Callback] Error syncing user:",r),i.NextResponse.redirect(new URL("/?error=Authentication error. Please try again.",e.url))}return i.NextResponse.redirect(new URL("/dashboard",e.url))}}if(p){console.log("[Auth Callback] Found access token in cookies, verifying user...");let{data:{user:r},error:a}=await u.auth.getUser(p);if(a||!r)return console.error("[Auth Callback] Invalid access token:",a),i.NextResponse.redirect(new URL("/?error=Invalid session",e.url));console.log("[Auth Callback] User authenticated via token:",r.id,r.email);let t=!1;try{let a=(0,n.l)(),{data:o,error:s}=await a.from("users").select("*").eq("auth_user_id",r.id).maybeSingle();if(s&&"PGRST116"!==s.code&&console.error("[Auth Callback] Error checking existing user:",s),o)t=!0;else{console.log("[Auth Callback] Creating new user in database via token flow");let{data:e,error:o}=await a.from("users").insert({auth_user_id:r.id,email:r.email||"",provider:r.app_metadata?.provider||"email",email_verified:!!r.email_confirmed_at||r.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();if(o){if(console.error("[Auth Callback] Error creating user:",o),"23505"===o.code){let{data:e}=await a.from("users").select("*").eq("auth_user_id",r.id).single();e&&(t=!0)}}else e&&(t=!0)}if(t)return i.NextResponse.redirect(new URL("/dashboard",e.url));return i.NextResponse.redirect(new URL("/?error=User creation failed",e.url))}catch(r){return console.error("[Auth Callback] Error syncing user:",r),i.NextResponse.redirect(new URL("/?error=Authentication error",e.url))}}console.log("[Auth Callback] No code or token - Supabase OAuth handled client-side, checking for session...");let m=e.cookies.getAll(),b=null;if(console.log("[Auth Callback] All cookies:",m.map(e=>({name:e.name,hasValue:!!e.value,valueLength:e.value?.length||0}))),b=e.cookies.get("sb-access-token")?.value||e.cookies.get(h)?.value||null)console.log("[Auth Callback] Found session token using standard pattern:",{cookieName:h,tokenLength:b.length});else for(let e of m){let r=e.name;if(r.includes("auth-token")||r.startsWith("sb-")&&r.includes("auth")){b=e.value,console.log("[Auth Callback] Found session token in cookie (fallback):",r);break}}if(b||console.log("[Auth Callback] No session token found. All cookie names:",m.map(e=>e.name)),b)try{let{data:{user:r},error:a}=await u.auth.getUser(b);if(r&&!a){console.log("[Auth Callback] Found user in session (client-side OAuth):",r.id,r.email);let a=(0,n.l)(),{data:t,error:o}=await a.from("users").select("*").eq("auth_user_id",r.id).maybeSingle();if(o&&"PGRST116"!==o.code&&console.error("[Auth Callback] Error checking existing user:",o),t)console.log("[Auth Callback] User already exists in database:",t.id);else{console.log("[Auth Callback] Creating new user in database (client-side OAuth flow)");let{data:e,error:t}=await a.from("users").insert({auth_user_id:r.id,email:r.email||"",provider:r.app_metadata?.provider||"email",email_verified:!!r.email_confirmed_at||r.app_metadata?.provider!=="email",license_key:"",notion_setup_complete:!1,onboarding_complete:!1}).select().single();t?(console.error("[Auth Callback] Error creating user:",{code:t.code,message:t.message,details:t.details}),"23505"===t.code&&console.log("[Auth Callback] User already exists (duplicate key)")):e&&console.log("[Auth Callback] User created successfully (client-side OAuth):",e.id)}return i.NextResponse.redirect(new URL("/dashboard",e.url))}console.log("[Auth Callback] Could not get user from session token:",a?.message)}catch(e){console.error("[Auth Callback] Error checking session for client-side OAuth:",e)}else console.log("[Auth Callback] No session token found in cookies");return console.log("[Auth Callback] Redirecting to dashboard (user creation will happen via /api/users/me fallback if needed)"),i.NextResponse.redirect(new URL("/dashboard",e.url))}let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/auth/callback/route",pathname:"/auth/callback",filename:"route",bundlePath:"app/auth/callback/route"},resolvedPagePath:"E:\\Work\\alex\\notion-assistant-alexa-skill\\web-login\\app\\auth\\callback\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:m}=d,b="/auth/callback/route";function k(){return(0,l.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},1570:(e,r,a)=>{a.d(r,{l:()=>l});var t=a(2851);let o="https://mwvurelnhrcbtpjtsiyb.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13dnVyZWxuaHJjYnRwanRzaXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MTE2NjYsImV4cCI6MjA4MDE4NzY2Nn0.4kMmjVKg9V0qUhQQMzxu9CdJuQ-zWpItaaqT3QzAEII";if(!o||!s)throw Error("Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. For local development, create a .env.local file. For production (Vercel), add them in your project settings.");if(o.includes("supabase.com/dashboard")||o.includes("dashboard/project"))throw Error(`❌ Invalid Supabase URL format!
  
Your NEXT_PUBLIC_SUPABASE_URL is set to: ${o}

This looks like a dashboard URL. It should be the API URL instead.

Correct format: https://[project-ref].supabase.co
Example: https://ptasyynqqlvrbhqmtvhl.supabase.co

To fix:
1. Go to Supabase Dashboard → Settings → API
2. Copy the "Project URL" (not the dashboard URL)
3. Update NEXT_PUBLIC_SUPABASE_URL in Vercel
4. Redeploy your application`);function l(){let e=process.env.SUPABASE_SERVICE_KEY||"",r="https://mwvurelnhrcbtpjtsiyb.supabase.co";if(!e||!r)throw Error("Missing SUPABASE_SERVICE_KEY or NEXT_PUBLIC_SUPABASE_URL");return(0,t.createClient)(r,e)}(0,t.createClient)(o,s)}};var r=require("../../../webpack-runtime.js");r.C(e);var a=e=>r(r.s=e),t=r.X(0,[942,786,851],()=>a(5772));module.exports=t})();